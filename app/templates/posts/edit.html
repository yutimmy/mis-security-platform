{% extends "layouts/base.html" %}

{% block title %}{% if post %}ç·¨è¼¯æ–‡ç« {% else %}æ’°å¯«æ–‡ç« {% endif %}{% endblock %}

{% block head %}
<!-- Markdown ç·¨è¼¯å™¨ç›¸é—œ CDN -->
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
<style>
/* ç¾ä»£åŒ–è¼¸å…¥æ¡†æ¨£å¼ */
.modern-input {
    width: 100%;
    min-height: 3.5rem;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #1f2937;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px solid #e5e7eb;
    border-radius: 1rem;
    outline: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    resize: none;
    overflow-y: hidden;
}

.modern-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    background: #ffffff;
    transform: translateY(-1px);
}

.modern-input::placeholder {
    color: #9ca3af;
    transition: color 0.3s ease;
}

.modern-input:focus::placeholder {
    color: #6b7280;
}

/* ç¾ä»£åŒ–æ¨™ç±¤æ¨£å¼ */
.modern-label {
    display: block;
    font-size: 0.95rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    transition: color 0.3s ease;
}

.input-group:focus-within .modern-label {
    color: #3b82f6;
}

/* ç¾ä»£åŒ–æŒ‰éˆ•æ¨£å¼ */
.modern-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.875rem 1.75rem;
    font-size: 0.95rem;
    font-weight: 600;
    text-decoration: none;
    border: none;
    border-radius: 0.875rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
    white-space: nowrap;
}

.modern-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.modern-btn:hover::before {
    left: 100%;
}

.modern-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.15);
}

.modern-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
}

.btn-primary-modern {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
}

.btn-primary-modern:hover {
    background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
}

.btn-secondary-modern {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    color: #475569;
    border: 1px solid #d1d5db;
}

.btn-secondary-modern:hover {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
    color: #334155;
}

.btn-success-modern {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.btn-success-modern:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
}

/* å·¥å…·æ¬„ç¾ä»£åŒ– */
.modern-toolbar-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    color: #475569;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    white-space: nowrap;
}

.modern-toolbar-btn:hover {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border-color: #cbd5e1;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.modern-toolbar-btn.active {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border-color: #3b82f6;
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
}

.editor-container {
    display: flex;
    gap: 1.5rem;
    min-height: 80vh; /* ä½¿ç”¨è¦–çª—é«˜åº¦çš„ 80% */
    border-radius: 1.25rem;
    overflow: hidden;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
}

.editor-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 1rem;
}

.editor-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 1px solid #e2e8f0;
    gap: 0.75rem;
    flex-wrap: wrap;
    border-radius: 1rem 1rem 0 0;
}

.toolbar-group {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}

.toolbar-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.toolbar-btn:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
    transform: translateY(-1px);
}

.toolbar-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.editor-textarea {
    flex: 1;
    width: 100%;
    min-height: 70vh; /* ä½¿ç”¨è¦–çª—é«˜åº¦çš„ 70% ä½œç‚ºæœ€å°é«˜åº¦ */
    max-height: none; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ */
    resize: vertical; /* å…è¨±å‚ç›´èª¿æ•´å¤§å° */
    font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', 'Consolas', monospace;
    font-size: 16px; /* å¢å¤§å­—é«” */
    line-height: 1.8; /* å¢åŠ è¡Œé«˜ */
    padding: 2rem;
    border: none;
    outline: none;
    background: linear-gradient(135deg, #fefefe 0%, #ffffff 100%);
    color: #1f2937;
    transition: all 0.3s ease;
}

.editor-textarea:focus {
    background: #ffffff;
    box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.1);
}

.preview-pane {
    flex: 1;
    border-left: 2px solid #f1f5f9;
    overflow-y: auto;
    background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
    border-radius: 0 1rem 1rem 0;
}

.preview-header {
    padding: 1rem 1.25rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 1px solid #e2e8f0;
    font-weight: 600;
    color: #475569;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 0 1rem 0 0;
}

.preview-content {
    padding: 2rem;
    line-height: 1.8;
    color: #1f2937;
    background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
    margin: 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    min-height: calc(100% - 3rem);
}

.preview-content h1 { 
    font-size: 2rem; 
    font-weight: 700; 
    margin-bottom: 1.5rem; 
    color: #111827;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 0.5rem;
}
.preview-content h2 { 
    font-size: 1.625rem; 
    font-weight: 600; 
    margin: 1.5rem 0 1rem 0; 
    color: #1f2937;
}
.preview-content h3 { 
    font-size: 1.375rem; 
    font-weight: 600; 
    margin: 1.25rem 0 0.75rem 0; 
    color: #374151;
}
.preview-content p { 
    margin-bottom: 1.25rem; 
    color: #4b5563;
}
.preview-content ul, .preview-content ol { 
    margin-bottom: 1.25rem; 
    padding-left: 1.75rem; 
}
.preview-content li { 
    margin-bottom: 0.5rem; 
    color: #4b5563;
}
.preview-content code { 
    background: #f1f5f9; 
    color: #e11d48; 
    padding: 0.125rem 0.375rem; 
    border-radius: 0.375rem; 
    font-family: 'JetBrains Mono', monospace; 
    font-size: 0.875rem;
    font-weight: 500;
}
.preview-content pre { 
    background: #0f172a; 
    color: #f1f5f9; 
    padding: 1.5rem; 
    border-radius: 0.75rem; 
    overflow-x: auto; 
    margin: 1.5rem 0; 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.preview-content pre code {
    background: transparent;
    color: inherit;
    padding: 0;
}
.preview-content blockquote { 
    border-left: 4px solid #3b82f6; 
    background: #f8fafc;
    padding: 1rem 1.5rem; 
    margin: 1.5rem 0; 
    font-style: italic; 
    border-radius: 0 0.5rem 0.5rem 0;
    color: #475569;
}
.preview-content img { 
    max-width: 100%; 
    height: auto; 
    border-radius: 0.75rem; 
    margin: 1.5rem 0; 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.preview-content table { 
    width: 100%; 
    border-collapse: collapse; 
    margin: 1.5rem 0; 
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}
.preview-content th, .preview-content td { 
    border: 1px solid #e5e7eb; 
    padding: 0.75rem 1rem; 
    text-align: left; 
}
.preview-content th { 
    background: #f8fafc; 
    font-weight: 600; 
    color: #374151;
}
.preview-content a {
    color: #3b82f6;
    text-decoration: underline;
    text-decoration-color: rgba(59, 130, 246, 0.3);
    text-underline-offset: 0.125em;
    transition: all 0.2s;
}
.preview-content a:hover {
    color: #1d4ed8;
    text-decoration-color: #1d4ed8;
}

/* éŸ¿æ‡‰å¼é è¦½æ¨¡å¼å„ªåŒ– */
@media (max-width: 1200px) {
    .preview-mode-active .editor-container {
        grid-template-columns: 1fr;
        gap: 0;
    }
    
    .preview-mode-active .editor-pane {
        border-radius: 1rem 1rem 0 0;
    }
    
    .preview-mode-active .preview-pane {
        border-radius: 0 0 1rem 1rem;
        border-left: none;
        border-top: 2px solid #f1f5f9;
    }
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 1024px) {
    .editor-container {
        gap: 1rem;
        min-height: 75vh; /* å¹³æ¿è¨­å‚™ä½¿ç”¨è¼ƒå°çš„è¦–çª—é«˜åº¦ */
    }
    
    .editor-textarea {
        font-size: 15px;
        padding: 1.5rem;
        min-height: 60vh; /* å¹³æ¿è¨­å‚™èª¿æ•´æœ€å°é«˜åº¦ */
    }
    
    .preview-content {
        padding: 1.5rem;
    }
}

@media (max-width: 768px) {
    .editor-container {
        flex-direction: column;
        min-height: 70vh; /* æ‰‹æ©Ÿè¨­å‚™ä½¿ç”¨é©ç•¶çš„è¦–çª—é«˜åº¦ */
        gap: 0;
    }
    
    .preview-pane {
        border-left: none;
        border-top: 2px solid #f1f5f9;
        min-height: 50vh; /* é è¦½å€åŸŸçµ¦äºˆå……è¶³çš„é«˜åº¦ */
        border-radius: 0 0 1rem 1rem;
    }
    
    .preview-header {
        border-radius: 0;
    }
    
    .editor-pane {
        border-radius: 1rem 1rem 0 0;
    }
    
    .editor-textarea {
        min-height: 50vh; /* æ‰‹æ©Ÿè¨­å‚™çµ¦äºˆæ›´å¤§çš„ç·¨è¼¯ç©ºé–“ */
        font-size: 16px; /* ä¿æŒè¼ƒå¤§å­—é«”ä»¥æå‡å¯è®€æ€§ */
        padding: 1.25rem;
    }
    
    .toolbar-group {
        justify-content: flex-start;
        gap: 0.5rem;
    }
    
    .modern-toolbar-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .modern-input {
        padding: 0.875rem 1rem;
        font-size: 0.95rem;
    }
    
    .modern-btn {
        padding: 0.75rem 1.5rem;
        font-size: 0.9rem;
    }
}

@media (max-width: 480px) {
    .editor-container {
        border-radius: 1rem;
        min-height: 65vh; /* å°è¢å¹•è¨­å‚™ä»éœ€è¦å……è¶³çš„ç·¨è¼¯ç©ºé–“ */
    }
    
    .editor-textarea {
        padding: 1rem;
        font-size: 15px; /* ä¿æŒé©ç•¶çš„å­—é«”å¤§å° */
        min-height: 45vh; /* å°è¢å¹•ä¹Ÿè¦æœ‰è¶³å¤ çš„ç·¨è¼¯ç©ºé–“ */
    }
    
    .preview-content {
        padding: 1rem;
        margin: 0.75rem;
    }
    
    .modern-input {
        padding: 0.75rem;
        font-size: 0.9rem;
    }
}

/* è¼‰å…¥å‹•ç•«å¢å¼· */
.loading-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: #6b7280;
    font-weight: 500;
}

.loading-preview::after {
    content: '';
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 0.75rem;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* å¢å¼·é è¦½æ¨¡å¼æ¨£å¼ */
.preview-mode-active .editor-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.preview-mode-active .preview-pane {
    display: block !important;
}

/* å¢å¼·ç·¨è¼¯å™¨ç„¦é»ç‹€æ…‹ */
.editor-textarea:focus {
    background: #ffffff;
    box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.1);
    transform: none; /* ç§»é™¤å¯èƒ½å¹²æ“¾çš„è®Šæ› */
}

/* ç¢ºä¿ç·¨è¼¯å™¨åœ¨å„ç¨®è¢å¹•å°ºå¯¸ä¸‹éƒ½æœ‰è‰¯å¥½çš„å¯è¦‹æ€§ */
.editor-pane {
    min-width: 0; /* é˜²æ­¢ flex é …ç›®æ”¶ç¸®éåº¦ */
}

/* æ”¹å–„å·¥å…·æ¬„åœ¨çª„è¢å¹•ä¸Šçš„é¡¯ç¤º */
.editor-toolbar {
    min-height: 4rem;
}

.toolbar-group {
    min-width: 0;
}

/* Badge æ¨£å¼ */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 0.375rem;
    white-space: nowrap;
}

.badge-primary {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

/* Toast æ¨£å¼å¢å¼· */
.toast {
    backdrop-filter: blur(10px);
    border-radius: 0.875rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* è‡ªé©æ‡‰é«˜åº¦å‹•ç•« */
.auto-resize {
    transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ç„¦é»ç‹€æ…‹å¢å¼· */
.input-group {
    position: relative;
}

.input-group::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, #3b82f6, #1d4ed8);
    border-radius: 1px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateX(-50%);
}

.input-group:focus-within::after {
    width: 100%;
}

/* æŒ‰éˆ•ç¾¤çµ„ */
.btn-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-end;
}

@media (max-width: 640px) {
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .modern-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="max-w-7xl mx-auto">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
                    {% if post %}ç·¨è¼¯æ–‡ç« {% else %}æ’°å¯«æ–‡ç« {% endif %}
                </h1>
                <p class="text-gray-600 text-sm mt-1">ä½¿ç”¨ Markdown èªæ³•æ’°å¯«æ‚¨çš„æ–‡ç« </p>
            </div>
            <a href="{% if post %}{{ url_for('posts.view', post_id=post.id) }}{% else %}{{ url_for('posts.index') }}{% endif %}" 
               class="toolbar-btn">
                â† è¿”å›
            </a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" enctype="multipart/form-data" class="space-y-8">
            <!-- åŸºæœ¬è³‡è¨Š -->
            <div class="modern-card p-8">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-2 h-8 bg-gradient-to-b from-blue-500 to-blue-600 rounded-full"></div>
                    <h2 class="text-xl font-bold text-gray-900">åŸºæœ¬è³‡è¨Š</h2>
                </div>
                
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div class="input-group">
                        <label for="title" class="modern-label">
                            ğŸ“ æ–‡ç« æ¨™é¡Œ *
                        </label>
                        <input type="text" 
                               id="title" 
                               name="title" 
                               required
                               value="{{ post.title if post else '' }}"
                               class="modern-input"
                               placeholder="è¼¸å…¥ä¸€å€‹å¸å¼•äººçš„æ¨™é¡Œ..."
                               autocomplete="off">
                    </div>
                    
                    <div class="input-group">
                        <label for="category" class="modern-label">
                            ğŸ·ï¸ æ–‡ç« åˆ†é¡
                        </label>
                        <input type="text" 
                               id="category" 
                               name="category"
                               value="{{ post.category if post and post.category else '' }}"
                               class="modern-input"
                               placeholder="ä¾‹å¦‚ï¼šæŠ€è¡“åˆ†äº«ã€è³‡å®‰åˆ†æã€å¿ƒå¾—ç­†è¨˜..."
                               autocomplete="off">
                    </div>
                </div>
                
                <div class="mt-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
                    <div class="flex items-start gap-4">
                        <div class="flex items-center mt-1">
                            <input type="checkbox" 
                                   id="is_published" 
                                   name="is_published" 
                                   value="1"
                                   {% if not post or post.is_published %}checked{% endif %}
                                   class="w-5 h-5 text-blue-600 focus:ring-blue-500 border-2 border-gray-300 rounded-md transition-all duration-200">
                        </div>
                        <div class="flex-1">
                            <label for="is_published" class="block cursor-pointer">
                                <span class="text-base font-semibold text-gray-900">ğŸš€ ç«‹å³ç™¼å¸ƒæ–‡ç« </span>
                                <p class="text-sm text-gray-600 mt-1">
                                    å‹¾é¸å¾Œæ–‡ç« å°‡ç«‹å³å°æ‰€æœ‰ç”¨æˆ¶å¯è¦‹ï¼Œå–æ¶ˆå‹¾é¸å°‡å„²å­˜ç‚ºè‰ç¨¿ç‹€æ…‹
                                </p>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Markdown ç·¨è¼¯å™¨ -->
            <div class="modern-card overflow-hidden">
                <div class="p-6 bg-gradient-to-r from-gray-50 to-blue-50 border-b border-gray-200">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-8 bg-gradient-to-b from-green-500 to-green-600 rounded-full"></div>
                            <h2 class="text-xl font-bold text-gray-900">ğŸ“„ æ–‡ç« å…§å®¹</h2>
                        </div>
                        <div class="flex items-center gap-3 text-sm">
                            <span class="hidden lg:inline-flex items-center gap-1 px-3 py-1.5 bg-white rounded-lg border border-gray-200 text-gray-600">
                                âœ¨ æ”¯æ´ Markdown èªæ³•
                            </span>
                            <div class="flex gap-2">
                                <span class="badge badge-primary">Ctrl+B ç²—é«”</span>
                                <span class="badge badge-primary">Ctrl+I æ–œé«”</span>
                                <span class="badge badge-primary hidden sm:inline">Ctrl+Enter é è¦½</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="editor-container" id="editor-container">
                    <!-- ç·¨è¼¯å€åŸŸ -->
                    <div class="editor-pane">
                        <div class="editor-toolbar">
                            <div class="toolbar-group">
                                <button type="button" onclick="insertMarkdown('**', '**')" class="modern-toolbar-btn" title="ç²—é«” (Ctrl+B)">
                                    <strong>B</strong>
                                </button>
                                <button type="button" onclick="insertMarkdown('*', '*')" class="modern-toolbar-btn" title="æ–œé«” (Ctrl+I)">
                                    <em>I</em>
                                </button>
                                <button type="button" onclick="insertMarkdown('# ', '')" class="modern-toolbar-btn" title="æ¨™é¡Œ">
                                    H1
                                </button>
                                <button type="button" onclick="insertMarkdown('`', '`')" class="modern-toolbar-btn" title="è¡Œå…§ç¨‹å¼ç¢¼">
                                    &lt;/&gt;
                                </button>
                                <button type="button" onclick="insertMarkdown('[', '](url)')" class="modern-toolbar-btn" title="é€£çµ (Ctrl+K)">
                                    ğŸ”—
                                </button>
                                <button type="button" onclick="insertMarkdown('![', '](url)')" class="modern-toolbar-btn" title="åœ–ç‰‡">
                                    ğŸ–¼ï¸
                                </button>
                                <button type="button" onclick="insertMarkdown('> ', '')" class="modern-toolbar-btn" title="å¼•ç”¨">
                                    ğŸ’¬
                                </button>
                            </div>
                            
                            <div class="toolbar-group">
                                <label for="image-upload" class="modern-toolbar-btn cursor-pointer" title="ä¸Šå‚³åœ–ç‰‡">
                                    ğŸ“ ä¸Šå‚³åœ–ç‰‡
                                </label>
                                <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="uploadImage(this)">
                                
                                <button type="button" onclick="togglePreview()" class="modern-toolbar-btn" id="preview-toggle" title="åˆ‡æ›é è¦½ (Ctrl+Enter)">
                                    ğŸ‘ï¸ é è¦½
                                </button>
                            </div>
                        </div>
                        
                        <textarea id="content" 
                                  name="content" 
                                  class="editor-textarea auto-resize" 
                                  placeholder="ğŸ¯ é–‹å§‹æ’°å¯«æ‚¨çš„æ–‡ç« ...

# é€™æ˜¯ä¸»æ¨™é¡Œ

## é€™æ˜¯å‰¯æ¨™é¡Œ

æ‚¨å¯ä»¥ä½¿ç”¨ **ç²—é«”** å’Œ *æ–œé«”* æ–‡å­—ä¾†å¼·èª¿é‡é»ã€‚

### ğŸ“‹ é …ç›®æ¸…å–®
- ç¬¬ä¸€å€‹é‡è¦é …ç›®
- ç¬¬äºŒå€‹é‡è¦é …ç›®  
- ç¬¬ä¸‰å€‹é‡è¦é …ç›®

### ğŸ’» ç¨‹å¼ç¢¼å€å¡Š
```python
def hello_world():
    print('Hello, World! ğŸŒ')
    return 'success'
```

### ğŸ’¡ å¼•ç”¨å€å¡Š
> é€™æ˜¯ä¸€æ®µé‡è¦çš„å¼•ç”¨æ–‡å­—ï¼Œå¯ä»¥ç”¨ä¾†çªå‡ºé—œéµè§€é»æˆ–åè¨€ã€‚

### ğŸ”— é€£çµå’Œåœ–ç‰‡
[å®˜æ–¹ç¶²ç«™](https://example.com)
![åœ–ç‰‡æè¿°](åœ–ç‰‡ç¶²å€)

---

**å°æç¤ºï¼š** ä½¿ç”¨å·¥å…·æ¬„æŒ‰éˆ•æˆ–éµç›¤å¿«æ·éµå¯ä»¥å¿«é€Ÿæ’å…¥ Markdown èªæ³•ï¼">{{ post.content if post else '' }}</textarea>
                    </div>
                    
                    <!-- é è¦½å€åŸŸ -->
                    <div class="editor-pane preview-pane" id="preview-pane" style="display: none;">
                        <div class="preview-header">
                            ğŸ“„ å³æ™‚é è¦½
                        </div>
                        <div class="preview-content" id="preview-content">
                            <div class="loading-preview">
                                æ­£åœ¨è¼‰å…¥é è¦½...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="btn-group">
                <a href="{% if post %}{{ url_for('posts.view', post_id=post.id) }}{% else %}{{ url_for('posts.index') }}{% endif %}"
                   class="modern-btn btn-secondary-modern">
                    â† å–æ¶ˆ
                </a>
                <button type="submit"
                        class="modern-btn btn-primary-modern">
                    {% if post %}ğŸ’¾ æ›´æ–°æ–‡ç« {% else %}ğŸš€ ç™¼å¸ƒæ–‡ç« {% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let previewMode = false;
let isPreviewLoading = false;
const contentTextarea = document.getElementById('content');
const previewPane = document.getElementById('preview-pane');
const previewContent = document.getElementById('preview-content');
const previewToggle = document.getElementById('preview-toggle');

// ç¢ºä¿ marked å’Œ DOMPurify è¼‰å…¥å®Œæˆ
function waitForLibraries() {
    return new Promise((resolve) => {
        const checkLibraries = () => {
            if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                // è¨­å®š marked é¸é …
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false // æˆ‘å€‘ç”¨ DOMPurify ä¾†æ¸…ç†
                });
                resolve();
            } else {
                setTimeout(checkLibraries, 50);
            }
        };
        checkLibraries();
    });
}

// å³æ™‚é è¦½æ›´æ–°
let updateTimeout;
contentTextarea.addEventListener('input', function() {
    if (previewMode && !isPreviewLoading) {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(updatePreview, 300); // é˜²æŠ–å‹•
    }
});

// åˆ‡æ›é è¦½æ¨¡å¼ - æ”¹å–„ç‰ˆæœ¬
async function togglePreview() {
    await waitForLibraries();
    
    previewMode = !previewMode;
    const editorContainer = document.querySelector('.editor-container');
    
    if (previewMode) {
        // å•Ÿç”¨é è¦½æ¨¡å¼
        previewPane.style.display = 'flex';
        previewToggle.classList.add('active');
        previewToggle.innerHTML = 'âœï¸ ç·¨è¼¯æ¨¡å¼';
        editorContainer.classList.add('preview-mode-active');
        
        // æ ¹æ“šè¢å¹•å°ºå¯¸é¸æ“‡ä½ˆå±€
        editorContainer.style.display = 'grid';
        if (window.innerWidth >= 1200) {
            // å¤§è¢å¹•ï¼šé›™æ¬„ä¸¦æ’
            editorContainer.style.gridTemplateColumns = '1fr 1fr';
            showToast('ğŸ‘ï¸ é›™æ¬„é è¦½æ¨¡å¼å·²å•Ÿç”¨ï¼', 'info', 2000);
        } else {
            // å°è¢å¹•ï¼šå–®æ¬„å †ç–Š
            editorContainer.style.gridTemplateColumns = '1fr';
            showToast('ğŸ‘ï¸ é è¦½æ¨¡å¼å·²å•Ÿç”¨ï¼', 'info', 2000);
        }
        
        updatePreview();
    } else {
        // å›åˆ°ç´”ç·¨è¼¯æ¨¡å¼
        previewPane.style.display = 'none';
        previewToggle.classList.remove('active');
        previewToggle.innerHTML = 'ğŸ‘ï¸ é è¦½';
        editorContainer.classList.remove('preview-mode-active');
        
        // æ¢å¾©å–®æ¬„é¡¯ç¤º
        editorContainer.style.display = 'flex';
        editorContainer.style.gridTemplateColumns = 'none';
        
        // ç„¦é»å›åˆ°ç·¨è¼¯å™¨
        setTimeout(() => {
            contentTextarea.focus();
        }, 100);
        
        showToast('âœï¸ å·²å›åˆ°ç·¨è¼¯æ¨¡å¼', 'info', 1500);
    }
}

// æ›´æ–°é è¦½å…§å®¹
async function updatePreview() {
    if (isPreviewLoading) return;
    
    isPreviewLoading = true;
    previewContent.innerHTML = '<div class="loading-preview">æ­£åœ¨æ›´æ–°é è¦½...</div>';
    
    try {
        await waitForLibraries();
        
        const markdownText = contentTextarea.value || '# é–‹å§‹æ’°å¯«æ‚¨çš„æ–‡ç« \n\nåœ¨å·¦å´ç·¨è¼¯å™¨ä¸­è¼¸å…¥ Markdown å…§å®¹ï¼Œé è¦½æœƒå³æ™‚æ›´æ–°ã€‚';
        
        // ä½¿ç”¨ marked è§£æ Markdown
        const htmlContent = marked.parse(markdownText);
        
        // ä½¿ç”¨ DOMPurify æ¸…ç† HTML
        const cleanContent = DOMPurify.sanitize(htmlContent, {
            ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'u', 's', 'del', 'ins', 'sub', 'sup', 'mark', 'small', 'hr', 'ul', 'ol', 'li', 'dl', 'dt', 'dd', 'blockquote', 'pre', 'code', 'a', 'img', 'table', 'thead', 'tbody', 'tfoot', 'tr', 'th', 'td', 'div', 'span'],
            ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'target', 'rel']
        });
        
        previewContent.innerHTML = cleanContent;
    } catch (error) {
        console.error('é è¦½æ›´æ–°å¤±æ•—:', error);
        previewContent.innerHTML = '<div class="text-red-600 p-4">é è¦½æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Markdown èªæ³•</div>';
    } finally {
        isPreviewLoading = false;
    }
}

// æ’å…¥ Markdown èªæ³•
function insertMarkdown(before, after) {
    const start = contentTextarea.selectionStart;
    const end = contentTextarea.selectionEnd;
    const selectedText = contentTextarea.value.substring(start, end);
    
    const newText = before + selectedText + after;
    
    contentTextarea.value = contentTextarea.value.substring(0, start) + newText + contentTextarea.value.substring(end);
    
    // è¨­å®šæ¸¸æ¨™ä½ç½®
    if (selectedText) {
        contentTextarea.selectionStart = start + before.length;
        contentTextarea.selectionEnd = start + before.length + selectedText.length;
    } else {
        contentTextarea.selectionStart = contentTextarea.selectionEnd = start + before.length;
    }
    
    contentTextarea.focus();
    autoResizeTextarea(contentTextarea);
    
    if (previewMode) {
        updatePreview();
    }
}

// è‡ªé©æ‡‰é«˜åº¦èª¿æ•´ - å„ªåŒ–ç‰ˆæœ¬
function autoResizeTextarea(textarea) {
    // ç§»é™¤åš´æ ¼çš„é«˜åº¦é™åˆ¶ï¼Œè®“ç·¨è¼¯å™¨æ ¹æ“šå…§å®¹è‡ªç„¶æˆé•·
    const currentHeight = textarea.style.height;
    textarea.style.height = 'auto';
    
    // ç²å–å¯¦éš›éœ€è¦çš„é«˜åº¦
    const scrollHeight = textarea.scrollHeight;
    
    // è¨­å®šæœ€å°é«˜åº¦ç‚º 70vhï¼Œä½†å…è¨±å…§å®¹å¢é•·
    const minHeight = Math.max(window.innerHeight * 0.7, 500);
    const newHeight = Math.max(scrollHeight, minHeight);
    
    // å¹³æ»‘èª¿æ•´é«˜åº¦
    textarea.style.height = newHeight + 'px';
    
    // ç¢ºä¿æœ‰æ»¾å‹•æ¢ç•¶å…§å®¹å¾ˆå¤šæ™‚
    if (scrollHeight > minHeight) {
        textarea.style.overflowY = 'auto';
    } else {
        textarea.style.overflowY = 'hidden';
    }
}

// æ¨™é¡Œè¼¸å…¥æ¡†è‡ªé©æ‡‰é«˜åº¦
function autoResizeInput(input) {
    // ç‚ºæ¨™é¡Œè¼¸å…¥æ¡†èª¿æ•´é«˜åº¦
    const minHeight = 56; // 3.5rem = 56px
    const maxHeight = 120;
    
    // å‰µå»ºè‡¨æ™‚å…ƒç´ ä¾†æ¸¬é‡æ–‡å­—é«˜åº¦
    const temp = document.createElement('div');
    temp.style.position = 'absolute';
    temp.style.visibility = 'hidden';
    temp.style.height = 'auto';
    temp.style.width = input.offsetWidth + 'px';
    temp.style.fontSize = window.getComputedStyle(input).fontSize;
    temp.style.fontFamily = window.getComputedStyle(input).fontFamily;
    temp.style.lineHeight = window.getComputedStyle(input).lineHeight;
    temp.style.padding = window.getComputedStyle(input).padding;
    temp.innerHTML = input.value.replace(/\n/g, '<br>') || input.placeholder;
    
    document.body.appendChild(temp);
    const scrollHeight = temp.offsetHeight;
    document.body.removeChild(temp);
    
    const newHeight = Math.min(Math.max(scrollHeight, minHeight), maxHeight);
    input.style.height = newHeight + 'px';
}

// å¢å¼·çš„åœ–ç‰‡ä¸Šå‚³
function uploadImage(input) {
    const file = input.files[0];
    if (!file) return;
    
    // æª¢æŸ¥æª”æ¡ˆé¡å‹
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        showToast('âŒ è«‹é¸æ“‡æ”¯æ´çš„åœ–ç‰‡æ ¼å¼ï¼šPNGã€JPEGã€WebP æˆ– GIF', 'error');
        return;
    }
    
    // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆ1.5MBï¼‰
    if (file.size > 1.5 * 1024 * 1024) {
        showToast('âš ï¸ åœ–ç‰‡æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 1.5MB\nå»ºè­°ä½¿ç”¨ç·šä¸Šå·¥å…·å£“ç¸®åœ–ç‰‡å¾Œå†ä¸Šå‚³', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('image', file);
    
    // é¡¯ç¤ºä¸Šå‚³é€²åº¦
    const uploadLabel = document.querySelector('label[for="image-upload"]');
    const originalText = uploadLabel.innerHTML;
    uploadLabel.innerHTML = 'â³ ä¸Šå‚³ä¸­...';
    uploadLabel.style.pointerEvents = 'none';
    uploadLabel.classList.add('active');
    
    // å‰µå»ºé€²åº¦æç¤º
    const progressToast = showToast('ğŸ“¤ æ­£åœ¨ä¸Šå‚³åœ–ç‰‡...', 'info', 0);
    
    fetch('/posts/upload-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (progressToast && progressToast.parentNode) {
            progressToast.parentNode.removeChild(progressToast);
        }
        
        if (data.code === 0) {
            // æ’å…¥ Markdown åœ–ç‰‡èªæ³•
            const imageMarkdown = `![${data.data.filename}](${data.data.url})\n`;
            const cursorPos = contentTextarea.selectionStart;
            const textBefore = contentTextarea.value.substring(0, cursorPos);
            const textAfter = contentTextarea.value.substring(cursorPos);
            
            contentTextarea.value = textBefore + imageMarkdown + textAfter;
            contentTextarea.selectionStart = contentTextarea.selectionEnd = cursorPos + imageMarkdown.length;
            contentTextarea.focus();
            
            // è‡ªå‹•èª¿æ•´é«˜åº¦
            autoResizeTextarea(contentTextarea);
            
            // æ›´æ–°é è¦½
            if (previewMode) {
                updatePreview();
            }
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            showToast('âœ… åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼', 'success');
        } else {
            showToast('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + data.message, 'error');
        }
    })
    .catch(error => {
        if (progressToast && progressToast.parentNode) {
            progressToast.parentNode.removeChild(progressToast);
        }
        console.error('ä¸Šå‚³éŒ¯èª¤:', error);
        showToast('âŒ ä¸Šå‚³æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦', 'error');
    })
    .finally(() => {
        uploadLabel.innerHTML = originalText;
        uploadLabel.style.pointerEvents = 'auto';
        uploadLabel.classList.remove('active');
        input.value = ''; // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
    });
}

// éµç›¤å¿«æ·éµ
contentTextarea.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + B = ç²—é«”
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        insertMarkdown('**', '**');
    }
    
    // Ctrl/Cmd + I = æ–œé«”
    if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
        e.preventDefault();
        insertMarkdown('*', '*');
    }
    
    // Ctrl/Cmd + K = é€£çµ
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        insertMarkdown('[', '](url)');
    }
    
    // Ctrl/Cmd + Enter = åˆ‡æ›é è¦½
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        togglePreview();
    }
    
    // Tab = ç¸®æ’
    if (e.key === 'Tab') {
        e.preventDefault();
        insertMarkdown('    ', '');
    }
});

// Toast æç¤ºè¨Šæ¯å¢å¼·
function showToast(message, type = 'info', autoHide = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast fixed top-6 right-6 z-50 p-4 rounded-xl shadow-2xl transition-all duration-500 transform translate-x-full max-w-sm`;
    
    let bgClass, iconEmoji;
    switch (type) {
        case 'success':
            bgClass = 'bg-gradient-to-r from-green-500 to-emerald-500 text-white';
            iconEmoji = 'âœ…';
            break;
        case 'error':
            bgClass = 'bg-gradient-to-r from-red-500 to-pink-500 text-white';
            iconEmoji = 'âŒ';
            break;
        case 'warning':
            bgClass = 'bg-gradient-to-r from-yellow-500 to-orange-500 text-white';
            iconEmoji = 'âš ï¸';
            break;
        default:
            bgClass = 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white';
            iconEmoji = 'â„¹ï¸';
    }
    
    toast.classList.add(...bgClass.split(' '));
    toast.innerHTML = `
        <div class="flex items-start gap-3">
            <span class="text-lg">${iconEmoji}</span>
            <div class="flex-1">
                <p class="font-medium">${message}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200 transition-colors">
                âœ•
            </button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // é¡¯ç¤ºå‹•ç•«
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
        toast.classList.add('translate-x-0');
    }, 100);
    
    // è‡ªå‹•æ¶ˆå¤±
    if (autoHide > 0) {
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 500);
        }, autoHide);
    }
    
    return toast;
}

// è‡ªå‹•å„²å­˜è‰ç¨¿å¢å¼·
let autoSaveTimeout;
let lastSavedContent = '';
let isDraftSaving = false;

function autoSaveDraft() {
    const currentContent = {
        title: document.getElementById('title').value,
        category: document.getElementById('category').value,
        content: contentTextarea.value
    };
    
    const currentContentStr = JSON.stringify(currentContent);
    
    // å¦‚æœå…§å®¹æ²’æœ‰è®ŠåŒ–ï¼Œä¸éœ€è¦å„²å­˜
    if (currentContentStr === lastSavedContent || isDraftSaving) {
        return;
    }
    
    // æª¢æŸ¥æ˜¯å¦æœ‰å¯¦è³ªå…§å®¹
    if (!currentContent.title.trim() && !currentContent.content.trim()) {
        return;
    }
    
    isDraftSaving = true;
    lastSavedContent = currentContentStr;
    
    // é€™è£¡å¯ä»¥å¯¦ä½œè‡ªå‹•å„²å­˜ API
    console.log('è‡ªå‹•å„²å­˜è‰ç¨¿...', currentContent);
    
    // æ¨¡æ“¬ API è«‹æ±‚
    setTimeout(() => {
        isDraftSaving = false;
        // showToast('ğŸ“ è‰ç¨¿å·²è‡ªå‹•å„²å­˜', 'info', 1500);
    }, 1000);
}

// è¼¸å…¥äº‹ä»¶ç›£è½
function setupAutoResize() {
    const titleInput = document.getElementById('title');
    const categoryInput = document.getElementById('category');
    
    // æ¨™é¡Œè¼¸å…¥æ¡†è‡ªé©æ‡‰
    titleInput.addEventListener('input', function() {
        autoResizeInput(this);
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(autoSaveDraft, 3000);
    });
    
    // åˆ†é¡è¼¸å…¥æ¡†è‡ªé©æ‡‰
    categoryInput.addEventListener('input', function() {
        autoResizeInput(this);
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(autoSaveDraft, 3000);
    });
    
    // å…§å®¹è¼¸å…¥æ¡†è‡ªé©æ‡‰
    contentTextarea.addEventListener('input', function() {
        autoResizeTextarea(this);
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(autoSaveDraft, 3000);
        
        if (previewMode && !isPreviewLoading) {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updatePreview, 300);
        }
    });
    
    // åˆå§‹åŒ–è‡ªé©æ‡‰é«˜åº¦
    autoResizeInput(titleInput);
    autoResizeInput(categoryInput);
    autoResizeTextarea(contentTextarea);
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // è¨­ç½®è‡ªé©æ‡‰é«˜åº¦
    setupAutoResize();
    
    // å„ªåŒ–ç·¨è¼¯å™¨åˆå§‹åŒ– - ç§»é™¤é«˜åº¦é™åˆ¶
    function initializeEditor() {
        const container = document.getElementById('editor-container');
        
        // ç¢ºä¿ç·¨è¼¯å™¨å®¹å™¨æœ‰è¶³å¤ çš„ç©ºé–“
        container.style.minHeight = '80vh';
        
        // ç¢ºä¿ textarea æœ‰èˆ’é©çš„ç·¨è¼¯ç©ºé–“
        const textarea = document.getElementById('content');
        textarea.style.minHeight = '70vh';
        
        // åˆå§‹ç„¦é»è¨­å®šåˆ° textarea
        setTimeout(() => {
            textarea.focus();
        }, 100);
    }
    
    initializeEditor();
    
    // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–ï¼Œä¿æŒè‰¯å¥½çš„ç·¨è¼¯é«”é©—
    window.addEventListener('resize', function() {
        autoResizeTextarea(contentTextarea);
        
        // éŸ¿æ‡‰å¼é è¦½æ¨¡å¼èª¿æ•´
        if (previewMode) {
            const editorContainer = document.querySelector('.editor-container');
            if (window.innerWidth >= 1200) {
                // å¤§è¢å¹•ï¼šé›™æ¬„é¡¯ç¤º
                editorContainer.style.display = 'grid';
                editorContainer.style.gridTemplateColumns = '1fr 1fr';
            } else {
                // å°è¢å¹•ï¼šå–®æ¬„å †ç–Š
                editorContainer.style.display = 'grid';
                editorContainer.style.gridTemplateColumns = '1fr';
            }
        }
    });
    
    // å¦‚æœæœ‰å…§å®¹ï¼Œåˆå§‹åŒ–é è¦½
    if (contentTextarea.value.trim() && previewMode) {
        updatePreview();
    }
    
    // è¨­ç½®åˆå§‹ä¿å­˜ç‹€æ…‹
    lastSavedContent = JSON.stringify({
        title: document.getElementById('title').value,
        category: document.getElementById('category').value,
        content: contentTextarea.value
    });
    
    // é é¢é›¢é–‹å‰æé†’
    window.addEventListener('beforeunload', function(e) {
        const currentContent = JSON.stringify({
            title: document.getElementById('title').value,
            category: document.getElementById('category').value,
            content: contentTextarea.value
        });
        
        if (currentContent !== lastSavedContent) {
            e.preventDefault();
            e.returnValue = 'æ‚¨æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
            return e.returnValue;
        }
    });
    
    // è¡¨å–®æäº¤æ™‚æ¸…é™¤è­¦å‘Š
    document.querySelector('form').addEventListener('submit', function() {
        lastSavedContent = JSON.stringify({
            title: document.getElementById('title').value,
            category: document.getElementById('category').value,
            content: contentTextarea.value
        });
    });
});
</script>
{% endblock %}
