{% extends "layouts/base.html" %}

{% block title %}
    {% if post %}Á∑®ËºØÊñáÁ´†{% else %}Êí∞ÂØ´ÊñáÁ´†{% endif %} - Ë≥áÂÆâÊÉÖË®äÂπ≥Ëá∫
{% endblock %}

{% block extra_head %}
    <!-- Markdown Áõ∏Èóú CDN -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js" crossorigin="anonymous"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .editor-container {
            min-height: calc(100vh - 200px);
        }

        .editor-textarea {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
        }

        .preview-content {
            font-size: 16px;
            line-height: 1.8;
        }

        .preview-content h1 {
            font-size: 2em;
            font-weight: 700;
            margin: 1em 0 0.5em;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .preview-content h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 0.83em 0 0.5em;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .preview-content h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin: 1em 0 0.5em;
        }

        .preview-content h4, .preview-content h5, .preview-content h6 {
            font-weight: 600;
            margin: 1em 0 0.5em;
        }

        .preview-content p {
            margin: 1em 0;
        }

        .preview-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }

        .preview-content pre {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 1em;
            overflow-x: auto;
            margin: 1em 0;
        }

        .preview-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            font-size: 0.875em;
        }

        .preview-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            margin: 1em 0;
            color: #6b7280;
            font-style: italic;
        }

        .preview-content ul, .preview-content ol {
            padding-left: 2em;
            margin: 1em 0;
        }

        .preview-content li {
            margin: 0.5em 0;
        }

        .preview-content a {
            color: #3b82f6;
            text-decoration: underline;
        }

        .preview-content a:hover {
            color: #2563eb;
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1em 0;
        }

        .preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .preview-content table th,
        .preview-content table td {
            border: 1px solid #e5e7eb;
            padding: 0.75em;
            text-align: left;
        }

        .preview-content table th {
            background: #f9fafb;
            font-weight: 600;
        }

        .preview-content hr {
            border: none;
            border-top: 2px solid #e5e7eb;
            margin: 2em 0;
        }

        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 9999;
            padding: 2rem;
            overflow-y: auto;
        }

        .focus-mode .editor-textarea {
            height: calc(100vh - 150px);
            min-height: auto;
        }

        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1rem 1.5rem;
            min-width: 300px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .drag-over {
            border: 2px dashed #3b82f6 !important;
            background: #eff6ff;
        }
    </style>
{% endblock %}

{% block content %}
<div id="editorApp" class="container mx-auto px-4 py-8">
    <!-- È†ÅÈù¢Ê®ôÈ°å -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">
            {% if post %}Á∑®ËºØÊñáÁ´†{% else %}Êí∞ÂØ´Êñ∞ÊñáÁ´†{% endif %}
        </h1>
        <p class="text-gray-600 mt-2">‰ΩøÁî® Markdown Ê†ºÂºèÊí∞ÂØ´ÊñáÁ´†ÔºåÊîØÊè¥Âç≥ÊôÇÈ†êË¶Ω</p>
    </div>

    <!-- Á∑®ËºØÂô®Ë°®ÂñÆ -->
    <form id="postForm" method="POST" class="space-y-6">
        <!-- Ê®ôÈ°åËº∏ÂÖ• -->
        <div class="bg-white rounded-lg shadow p-6">
            <label for="title" class="block text-sm font-medium text-gray-700 mb-2">ÊñáÁ´†Ê®ôÈ°å *</label>
            <input 
                type="text" 
                id="title" 
                name="title" 
                value="{{ post.title if post else '' }}"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Ëº∏ÂÖ•ÊñáÁ´†Ê®ôÈ°å..."
                required
            >
        </div>

        <!-- ÂàÜÈ°ûËº∏ÂÖ• -->
        <div class="bg-white rounded-lg shadow p-6">
            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">ÂàÜÈ°ûÔºàÈÅ∏Â°´Ôºâ</label>
            <input 
                type="text" 
                id="category" 
                name="category" 
                value="{{ post.category if post else '' }}"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="‰æãÂ¶ÇÔºöÂÆâÂÖ®ÂÖ¨Âëä„ÄÅÊäÄË°ìÂàÜ‰∫´„ÄÅÊºèÊ¥ûÂàÜÊûê..."
            >
        </div>

        <!-- Á∑®ËºØÂô®‰∏ªÈ´î -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <!-- Â∑•ÂÖ∑Âàó -->
            <div class="border-b border-gray-200 p-4 flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center space-x-2 flex-wrap gap-2">
                    <!-- Markdown Ê†ºÂºèÂåñÊåâÈàï -->
                    <button type="button" onclick="insertMarkdown('**', '**', 'Á≤óÈ´îÊñáÂ≠ó')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm font-medium" 
                            title="Á≤óÈ´î (Ctrl+B)">
                        <strong>B</strong>
                    </button>
                    <button type="button" onclick="insertMarkdown('*', '*', 'ÊñúÈ´îÊñáÂ≠ó')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm italic" 
                            title="ÊñúÈ´î (Ctrl+I)">
                        I
                    </button>
                    <button type="button" onclick="insertMarkdown('~~', '~~', 'Âà™Èô§Á∑ö')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm" 
                            title="Âà™Èô§Á∑ö">
                        <s>S</s>
                    </button>
                    <button type="button" onclick="insertMarkdown('`', '`', 'Á®ãÂºèÁ¢º')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm font-mono" 
                            title="Ë°åÂÖßÁ®ãÂºèÁ¢º">
                        &lt;/&gt;
                    </button>
                    <button type="button" onclick="insertLink()" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm" 
                            title="ÊèíÂÖ•ÈÄ£Áµê (Ctrl+K)">
                        üîó
                    </button>
                    <button type="button" onclick="insertImage()" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm" 
                            title="ÊèíÂÖ•ÂúñÁâá">
                        üñºÔ∏è
                    </button>
                    <button type="button" onclick="insertHeading()" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm font-bold" 
                            title="ÊèíÂÖ•Ê®ôÈ°å">
                        H
                    </button>
                    <button type="button" onclick="insertList()" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm" 
                            title="ÊèíÂÖ•Ê∏ÖÂñÆ">
                        ‚â°
                    </button>
                </div>

                <div class="flex items-center space-x-3">
                    <!-- Â≠óÊï∏Áµ±Ë®à -->
                    <div class="text-sm text-gray-500">
                        <span id="charCount">0</span> Â≠ó
                    </div>
                </div>
            </div>

            <!-- Á∑®ËºØÂçÄÂüü -->
            <div class="editor-container grid grid-cols-1 lg:grid-cols-2 gap-0">
                <!-- ÊñáÂ≠óËº∏ÂÖ•ÂçÄ -->
                <div class="p-4 border-r border-gray-200" id="editorPane">
                    <textarea 
                        id="content" 
                        name="content" 
                        class="editor-textarea w-full h-[600px] p-4 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Âú®Ê≠§Ëº∏ÂÖ• Markdown Ê†ºÂºèÁöÑÊñáÁ´†ÂÖßÂÆπ..."
                        required
                    >{{ post.content if post else '' }}</textarea>
                </div>

                <!-- È†êË¶ΩÂçÄ -->
                <div id="previewPane" class="p-4 bg-gray-50">
                    <div id="previewContent" class="preview-content h-[600px] overflow-y-auto p-4">
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="text-lg">ÈñãÂßãËº∏ÂÖ•‰ª•Êü•ÁúãÈ†êË¶Ω</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁôºÂ∏ÉË®≠ÂÆö -->
        <div class="bg-white rounded-lg shadow p-6">
            <label class="flex items-center space-x-3">
                <input 
                    type="checkbox" 
                    id="is_published" 
                    name="is_published" 
                    value="1"
                    {% if post and post.is_published %}checked{% endif %}
                    class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                >
                <span class="text-sm font-medium text-gray-700">
                    Á´ãÂç≥ÁôºÂ∏ÉÔºàÂèñÊ∂àÂãæÈÅ∏ÂâáÂÑ≤Â≠òÁÇ∫ËçâÁ®øÔºâ
                </span>
            </label>
        </div>

        <!-- Êìç‰ΩúÊåâÈàï -->
        <div class="flex items-center justify-between">
            <a href="{{ url_for('posts.my_posts') }}" 
               class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors">
                ÂèñÊ∂à
            </a>
            <div class="flex items-center space-x-3">
                <span id="saveStatus" class="text-sm text-gray-500"></span>
                <button type="submit" 
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                    {% if post %}Êõ¥Êñ∞ÊñáÁ´†{% else %}ÁôºÂ∏ÉÊñáÁ´†{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

<!-- ÂúñÁâá‰∏äÂÇ≥ Modal -->
<div id="imageUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
        <h3 class="text-lg font-bold mb-4">‰∏äÂÇ≥ÂúñÁâá</h3>
        <input type="file" id="imageFileInput" accept="image/*" class="w-full mb-4">
        <div class="flex justify-end space-x-3">
            <button type="button" onclick="closeImageModal()" 
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">
                ÂèñÊ∂à
            </button>
            <button type="button" onclick="uploadImage()" 
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                ‰∏äÂÇ≥
            </button>
        </div>
    </div>
</div>

<script>
// ÂÖ®ÂüüËÆäÊï∏
let autoSaveTimer = null;
let contentTextarea = null;
let previewContent = null;
let previewPane = null;
let editorPane = null;

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    contentTextarea = document.getElementById('content');
    previewContent = document.getElementById('previewContent');
    previewPane = document.getElementById('previewPane');
    editorPane = document.getElementById('editorPane');
    
    if (!contentTextarea) {
        console.error('Editor textarea not found');
        return;
    }

    // Á≠âÂæÖ CDN ËºâÂÖ•
    waitForCDN().then(() => {
        // Á∂ÅÂÆöËº∏ÂÖ•‰∫ã‰ª∂ - Âç≥ÊôÇÊõ¥Êñ∞È†êË¶Ω
        contentTextarea.addEventListener('input', function() {
            updateCharCount();
            updatePreview(); // ÊØèÊ¨°Ëº∏ÂÖ•ÈÉΩÊõ¥Êñ∞È†êË¶Ω
            scheduleAutoSave();
        });

        // Á∂ÅÂÆöÂø´Êç∑Èçµ
        contentTextarea.addEventListener('keydown', handleKeyboardShortcuts);

        // ÊãñÊãΩ‰∏äÂÇ≥
        initializeDragDrop();

        // ÂàùÂßãÂ≠óÊï∏Áµ±Ë®à
        updateCharCount();

        // ËºâÂÖ•ËçâÁ®øÔºàÂÉÖÈôêÊñ∞ÊñáÁ´†Ôºâ
        {% if not post %}
        loadDraft();
        {% endif %}

        // Â¶ÇÊûúÊúâÂÖßÂÆπÔºåÁ´ãÂç≥ÂàùÂßãÂåñÈ†êË¶Ω
        if (contentTextarea.value.trim()) {
            updatePreview();
        }
    });
});

// Á≠âÂæÖ CDN Â∫´ËºâÂÖ•
function waitForCDN() {
    return new Promise((resolve) => {
        let attempts = 0;
        const maxAttempts = 10;
        
        const checkCDN = () => {
            if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                // ÈÖçÁΩÆ marked
                if (marked.setOptions) {
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        headerIds: true,
                        mangle: false,
                        sanitize: false,
                        smartLists: true,
                        smartypants: false
                    });
                }
                resolve(true);
            } else {
                attempts++;
                if (attempts < maxAttempts) {
                    setTimeout(checkCDN, 200);
                } else {
                    console.error('CDN libraries failed to load');
                    showToast('Markdown Ëß£ÊûêÂô®ËºâÂÖ•Â§±ÊïóÔºåÈ†êË¶ΩÂäüËÉΩÂ∞áÁÑ°Ê≥ï‰ΩøÁî®', 'error');
                    resolve(false);
                }
            }
        };
        
        checkCDN();
    });
}

// Êõ¥Êñ∞È†êË¶Ω
function updatePreview() {
    if (!previewContent || typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
        return;
    }

    const content = contentTextarea.value.trim();

    if (!content) {
        previewContent.innerHTML = `
            <div class="text-center py-12 text-gray-400">
                <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="text-lg">ÈñãÂßãËº∏ÂÖ•‰ª•Êü•ÁúãÈ†êË¶Ω</p>
            </div>
        `;
        return;
    }

    try {
        // Ëß£Êûê Markdown
        const rawHtml = marked.parse(content);
        
        // Ê∏ÖÁêÜ HTML
        const cleanHtml = DOMPurify.sanitize(rawHtml, {
            ALLOWED_TAGS: [
                'p', 'br', 'strong', 'em', 'u', 'del', 'mark',
                'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                'ul', 'ol', 'li', 'dl', 'dt', 'dd',
                'blockquote', 'pre', 'code',
                'a', 'img',
                'table', 'thead', 'tbody', 'tfoot', 'tr', 'th', 'td',
                'div', 'span', 'hr'
            ],
            ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id'],
            KEEP_CONTENT: true
        });

        previewContent.innerHTML = cleanHtml;

        // È´ò‰∫ÆÁ®ãÂºèÁ¢º
        if (typeof hljs !== 'undefined') {
            previewContent.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        // Â§ñÈÉ®ÈÄ£ÁµêË®≠ÂÆö
        previewContent.querySelectorAll('a').forEach((link) => {
            if (link.hostname !== window.location.hostname) {
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
            }
        });

    } catch (error) {
        console.error('Preview update error:', error);
        previewContent.innerHTML = `
            <div class="text-center py-12 text-red-500">
                <p class="text-lg font-medium">È†êË¶ΩËß£ÊûêÈåØË™§</p>
                <p class="text-sm mt-2">${error.message}</p>
            </div>
        `;
    }
}

// Êõ¥Êñ∞Â≠óÊï∏Áµ±Ë®à
function updateCharCount() {
    const charCount = document.getElementById('charCount');
    if (charCount && contentTextarea) {
        const count = contentTextarea.value.length;
        charCount.textContent = count.toLocaleString();
    }
}

// ÊèíÂÖ• Markdown Ê®ôË®ò
function insertMarkdown(before, after, placeholder) {
    const start = contentTextarea.selectionStart;
    const end = contentTextarea.selectionEnd;
    const selectedText = contentTextarea.value.substring(start, end);
    const textToInsert = selectedText || placeholder;
    const newText = before + textToInsert + after;
    
    contentTextarea.setRangeText(newText, start, end, 'end');
    contentTextarea.focus();
    
    // Â¶ÇÊûúÊ≤íÊúâÈÅ∏ÂèñÊñáÂ≠óÔºåÈÅ∏‰∏≠ÊèíÂÖ•ÁöÑ placeholder
    if (!selectedText) {
        contentTextarea.setSelectionRange(start + before.length, start + before.length + placeholder.length);
    }
    
    contentTextarea.dispatchEvent(new Event('input'));
}

// ÊèíÂÖ•ÈÄ£Áµê
function insertLink() {
    const url = prompt('Ë´ãËº∏ÂÖ•ÈÄ£ÁµêÁ∂≤ÂùÄÔºö');
    if (url) {
        const start = contentTextarea.selectionStart;
        const end = contentTextarea.selectionEnd;
        const selectedText = contentTextarea.value.substring(start, end) || 'ÈÄ£ÁµêÊñáÂ≠ó';
        const linkText = `[${selectedText}](${url})`;
        
        contentTextarea.setRangeText(linkText, start, end, 'end');
        contentTextarea.focus();
        contentTextarea.dispatchEvent(new Event('input'));
    }
}

// ÊèíÂÖ•ÂúñÁâá
function insertImage() {
    document.getElementById('imageUploadModal').classList.remove('hidden');
}

// ÈóúÈñâÂúñÁâá Modal
function closeImageModal() {
    document.getElementById('imageUploadModal').classList.add('hidden');
    document.getElementById('imageFileInput').value = '';
}

// ‰∏äÂÇ≥ÂúñÁâá
function uploadImage() {
    const fileInput = document.getElementById('imageFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Ë´ãÈÅ∏ÊìáÂúñÁâáÊ™îÊ°à', 'warning');
        return;
    }

    if (!file.type.startsWith('image/')) {
        showToast('Ë´ãÈÅ∏ÊìáÂúñÁâáÊ™îÊ°à', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('image', file);

    const uploadBtn = event.target;
    uploadBtn.disabled = true;
    uploadBtn.textContent = '‰∏äÂÇ≥‰∏≠...';

    fetch('/posts/upload-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 0) {
            const imageUrl = data.data.url;
            const imageMarkdown = `![${file.name}](${imageUrl})`;
            
            const pos = contentTextarea.selectionStart;
            contentTextarea.setRangeText(imageMarkdown, pos, pos, 'end');
            contentTextarea.focus();
            contentTextarea.dispatchEvent(new Event('input'));
            
            showToast('ÂúñÁâá‰∏äÂÇ≥ÊàêÂäü', 'success');
            closeImageModal();
        } else {
            showToast(data.message || '‰∏äÂÇ≥Â§±Êïó', 'error');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showToast('‰∏äÂÇ≥Â§±ÊïóÔºåË´ãÁ®çÂæåÈáçË©¶', 'error');
    })
    .finally(() => {
        uploadBtn.disabled = false;
        uploadBtn.textContent = '‰∏äÂÇ≥';
    });
}

// ÊèíÂÖ•Ê®ôÈ°å
function insertHeading() {
    const level = prompt('Ë´ãËº∏ÂÖ•Ê®ôÈ°åÁ¥öÂà• (1-6):', '2');
    if (level && /^[1-6]$/.test(level)) {
        const heading = '#'.repeat(parseInt(level)) + ' ';
        const start = contentTextarea.selectionStart;
        contentTextarea.setRangeText(heading, start, start, 'end');
        contentTextarea.focus();
        contentTextarea.dispatchEvent(new Event('input'));
    }
}

// ÊèíÂÖ•Ê∏ÖÂñÆ
function insertList() {
    const type = confirm('Á¢∫ÂÆöÂª∫Á´ãÊúâÂ∫èÊ∏ÖÂñÆÔºüÂèñÊ∂àÂâáÂª∫Á´ãÁÑ°Â∫èÊ∏ÖÂñÆ');
    const prefix = type ? '1. ' : '- ';
    const start = contentTextarea.selectionStart;
    contentTextarea.setRangeText(prefix, start, start, 'end');
    contentTextarea.focus();
    contentTextarea.dispatchEvent(new Event('input'));
}

// ÈçµÁõ§Âø´Êç∑Èçµ
function handleKeyboardShortcuts(e) {
    // Ctrl/Cmd + B = Á≤óÈ´î
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        insertMarkdown('**', '**', 'Á≤óÈ´îÊñáÂ≠ó');
    }
    
    // Ctrl/Cmd + I = ÊñúÈ´î
    if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
        e.preventDefault();
        insertMarkdown('*', '*', 'ÊñúÈ´îÊñáÂ≠ó');
    }
    
    // Ctrl/Cmd + K = ÈÄ£Áµê
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        insertLink();
    }
}

// ÊãñÊãΩ‰∏äÂÇ≥ÂàùÂßãÂåñ
function initializeDragDrop() {
    const editorPane = document.getElementById('editorPane');
    
    editorPane.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        editorPane.classList.add('drag-over');
    });
    
    editorPane.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        editorPane.classList.remove('drag-over');
    });
    
    editorPane.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        editorPane.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
            uploadDroppedImage(files[0]);
        }
    });
}

// ‰∏äÂÇ≥ÊãñÊîæÁöÑÂúñÁâá
function uploadDroppedImage(file) {
    const formData = new FormData();
    formData.append('image', file);

    showToast('‰∏äÂÇ≥‰∏≠...', 'info');

    fetch('/posts/upload-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 0) {
            const imageUrl = data.data.url;
            const imageMarkdown = `![${file.name}](${imageUrl})`;
            
            const pos = contentTextarea.selectionStart;
            contentTextarea.setRangeText(imageMarkdown, pos, pos, 'end');
            contentTextarea.focus();
            contentTextarea.dispatchEvent(new Event('input'));
            
            showToast('ÂúñÁâá‰∏äÂÇ≥ÊàêÂäü', 'success');
        } else {
            showToast(data.message || '‰∏äÂÇ≥Â§±Êïó', 'error');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showToast('‰∏äÂÇ≥Â§±ÊïóÔºåË´ãÁ®çÂæåÈáçË©¶', 'error');
    });
}

// Ëá™ÂãïÂÑ≤Â≠ò
function scheduleAutoSave() {
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    
    const saveStatus = document.getElementById('saveStatus');
    if (saveStatus) {
        saveStatus.textContent = 'Êú™ÂÑ≤Â≠ò';
        saveStatus.className = 'text-sm text-gray-400';
    }
    
    autoSaveTimer = setTimeout(() => {
        // ÂÑ≤Â≠òÂà∞ localStorage
        const draftData = {
            title: document.getElementById('title').value,
            content: contentTextarea.value,
            category: document.getElementById('category').value,
            timestamp: new Date().toISOString()
        };
        
        try {
            localStorage.setItem('post_draft', JSON.stringify(draftData));
            
            if (saveStatus) {
                saveStatus.textContent = 'Â∑≤Ëá™ÂãïÂÑ≤Â≠ò';
                saveStatus.className = 'text-sm text-green-600';
                
                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 3000);
            }
        } catch (error) {
            console.error('Auto-save error:', error);
        }
    }, 3000);
}

// ËºâÂÖ•ËçâÁ®ø
function loadDraft() {
    try {
        const draftData = localStorage.getItem('post_draft');
        if (draftData) {
            const draft = JSON.parse(draftData);
            const draftTime = new Date(draft.timestamp);
            const now = new Date();
            const hoursDiff = (now - draftTime) / (1000 * 60 * 60);
            
            // Âè™ËºâÂÖ• 24 Â∞èÊôÇÂÖßÁöÑËçâÁ®ø
            if (hoursDiff < 24) {
                const confirm = window.confirm(
                    `ÁôºÁèæÊú™ÂÆåÊàêÁöÑËçâÁ®øÔºà${draftTime.toLocaleString()}Ôºâ\n` +
                    `ÊòØÂê¶ËºâÂÖ•Ôºü\n\n` +
                    `Ê®ôÈ°å: ${draft.title || 'ÔºàÁÑ°Ê®ôÈ°åÔºâ'}`
                );
                
                if (confirm) {
                    document.getElementById('title').value = draft.title || '';
                    contentTextarea.value = draft.content || '';
                    document.getElementById('category').value = draft.category || '';
                    
                    updateCharCount();
                    if (isPreviewMode) {
                        updatePreview();
                    }
                    
                    showToast('ËçâÁ®øÂ∑≤ËºâÂÖ•', 'success');
                }
            }
        }
    } catch (error) {
        console.error('Load draft error:', error);
    }
}

// Ê∏ÖÈô§ËçâÁ®ø
function clearDraft() {
    try {
        localStorage.removeItem('post_draft');
    } catch (error) {
        console.error('Clear draft error:', error);
    }
}

// Toast ÈÄöÁü•
function showToast(message, type = 'info', duration = 3000) {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    const colors = {
        success: 'border-l-4 border-green-500',
        error: 'border-l-4 border-red-500',
        warning: 'border-l-4 border-yellow-500',
        info: 'border-l-4 border-blue-500'
    };
    
    const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast ${colors[type]}`;
    toast.innerHTML = `
        <div class="flex items-center">
            <span class="text-2xl mr-3">${icons[type]}</span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// Ë°®ÂñÆÊèê‰∫§ÂâçÈ©óË≠â
document.getElementById('postForm').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const content = contentTextarea.value.trim();
    
    if (!title) {
        e.preventDefault();
        showToast('Ë´ãËº∏ÂÖ•ÊñáÁ´†Ê®ôÈ°å', 'warning');
        return false;
    }
    
    if (!content) {
        e.preventDefault();
        showToast('Ë´ãËº∏ÂÖ•ÊñáÁ´†ÂÖßÂÆπ', 'warning');
        return false;
    }
    
    // Ê∏ÖÈô§ËçâÁ®øÔºàÂõ†ÁÇ∫Âç≥Â∞áÂÑ≤Â≠òÂà∞‰º∫ÊúçÂô®Ôºâ
    clearDraft();
    
    return true;
});
</script>
{% endblock %}
