{% extends "layouts/base.html" %}

{% block title %}
    {% if post %}ç·¨è¼¯æ–‡ç« {% else %}æ’°å¯«æ–‡ç« {% endif %} - è³‡å®‰æƒ…è¨Šå¹³è‡º
{% endblock %}

{% block extra_head %}
    <!-- Markdown ç›¸é—œ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js" crossorigin="anonymous"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .editor-container {
            min-height: calc(100vh - 200px);
        }

        .editor-textarea {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
        }

        .preview-content {
            font-size: 16px;
            line-height: 1.8;
        }

        .preview-content h1 {
            font-size: 2em;
            font-weight: 700;
            margin: 1em 0 0.5em;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .preview-content h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 0.83em 0 0.5em;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .preview-content h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin: 1em 0 0.5em;
        }

        .preview-content h4, .preview-content h5, .preview-content h6 {
            font-weight: 600;
            margin: 1em 0 0.5em;
        }

        .preview-content p {
            margin: 1em 0;
        }

        .preview-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }

        .preview-content pre {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 1em;
            overflow-x: auto;
            margin: 1em 0;
        }

        .preview-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            font-size: 0.875em;
        }

        .preview-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            margin: 1em 0;
            color: #6b7280;
            font-style: italic;
        }

        .preview-content ul, .preview-content ol {
            padding-left: 2em;
            margin: 1em 0;
        }

        .preview-content li {
            margin: 0.5em 0;
        }

        .preview-content a {
            color: #3b82f6;
            text-decoration: underline;
        }

        .preview-content a:hover {
            color: #2563eb;
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1em 0;
        }

        .preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .preview-content table th,
        .preview-content table td {
            border: 1px solid #e5e7eb;
            padding: 0.75em;
            text-align: left;
        }

        .preview-content table th {
            background: #f9fafb;
            font-weight: 600;
        }

        .preview-content hr {
            border: none;
            border-top: 2px solid #e5e7eb;
            margin: 2em 0;
        }

        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 9999;
            padding: 2rem;
            overflow-y: auto;
        }

        .focus-mode .editor-textarea {
            height: calc(100vh - 150px);
            min-height: auto;
        }

        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1rem 1.5rem;
            min-width: 300px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .drag-over {
            border: 2px dashed #3b82f6 !important;
            background: #eff6ff;
        }
    </style>
{% endblock %}

{% block content %}
<div id="editorApp" class="container mx-auto px-4 py-8">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">
            {% if post %}ç·¨è¼¯æ–‡ç« {% else %}æ’°å¯«æ–°æ–‡ç« {% endif %}
        </h1>
        <p class="text-gray-600 mt-2">ä½¿ç”¨ Markdown æ ¼å¼æ’°å¯«æ–‡ç« ï¼Œæ”¯æ´å³æ™‚é è¦½</p>
    </div>

    <!-- ç·¨è¼¯å™¨è¡¨å–® -->
    <form id="postForm" method="POST" class="space-y-6">
        <!-- æ¨™é¡Œè¼¸å…¥ -->
        <div class="bg-white rounded-lg shadow p-6">
            <label for="title" class="block text-sm font-medium text-gray-700 mb-2">æ–‡ç« æ¨™é¡Œ *</label>
            <input 
                type="text" 
                id="title" 
                name="title" 
                value="{{ post.title if post else '' }}"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="è¼¸å…¥æ–‡ç« æ¨™é¡Œ..."
                required
            >
        </div>

        <!-- åˆ†é¡è¼¸å…¥ -->
        <div class="bg-white rounded-lg shadow p-6">
            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">åˆ†é¡ï¼ˆé¸å¡«ï¼‰</label>
            <input 
                type="text" 
                id="category" 
                name="category" 
                value="{{ post.category if post else '' }}"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="ä¾‹å¦‚ï¼šå®‰å…¨å…¬å‘Šã€æŠ€è¡“åˆ†äº«ã€æ¼æ´åˆ†æ..."
            >
        </div>

        <!-- ç·¨è¼¯å™¨ä¸»é«” -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <!-- å·¥å…·åˆ— -->
            <div class="border-b border-gray-200 p-4 flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center space-x-2 flex-wrap gap-2">
                    <!-- Markdown æ ¼å¼åŒ–æŒ‰éˆ• -->
                    <button type="button" onclick="insertMarkdown('**', '**', 'ç²—é«”æ–‡å­—')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm font-medium" 
                            title="ç²—é«” (Ctrl+B)">
                        <strong>B</strong>
                    </button>
                    <button type="button" onclick="insertMarkdown('*', '*', 'æ–œé«”æ–‡å­—')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm italic" 
                            title="æ–œé«” (Ctrl+I)">
                        I
                    </button>
                    <button type="button" onclick="insertMarkdown('~~', '~~', 'åˆªé™¤ç·š')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm" 
                            title="åˆªé™¤ç·š">
                        <s>S</s>
                    </button>
                    <button type="button" onclick="insertMarkdown('`', '`', 'ç¨‹å¼ç¢¼')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm font-mono" 
                            title="è¡Œå…§ç¨‹å¼ç¢¼">
                        &lt;/&gt;
                    </button>
                    <button type="button" onclick="insertLink()" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm" 
                            title="æ’å…¥é€£çµ (Ctrl+K)">
                        ğŸ”—
                    </button>
                    <button type="button" onclick="insertImage()" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm" 
                            title="æ’å…¥åœ–ç‰‡">
                        ğŸ–¼ï¸
                    </button>
                    <button type="button" onclick="insertHeading()" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm font-bold" 
                            title="æ’å…¥æ¨™é¡Œ">
                        H
                    </button>
                    <button type="button" onclick="insertList()" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm" 
                            title="æ’å…¥æ¸…å–®">
                        â‰¡
                    </button>
                </div>

                <div class="flex items-center space-x-3">
                    <!-- å­—æ•¸çµ±è¨ˆ -->
                    <div class="text-sm text-gray-500">
                        <span id="charCount">0</span> å­—
                    </div>
                </div>
            </div>

            <!-- ç·¨è¼¯å€åŸŸ -->
            <div class="editor-container grid grid-cols-1 lg:grid-cols-2 gap-0">
                <!-- æ–‡å­—è¼¸å…¥å€ -->
                <div class="p-4 border-r border-gray-200" id="editorPane">
                    <textarea 
                        id="content" 
                        name="content" 
                        class="editor-textarea w-full h-[600px] p-4 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="åœ¨æ­¤è¼¸å…¥ Markdown æ ¼å¼çš„æ–‡ç« å…§å®¹..."
                        required
                    >{{ post.content if post else '' }}</textarea>
                </div>

                <!-- é è¦½å€ -->
                <div id="previewPane" class="p-4 bg-gray-50">
                    <div id="previewContent" class="preview-content h-[600px] overflow-y-auto p-4">
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="text-lg">é–‹å§‹è¼¸å…¥ä»¥æŸ¥çœ‹é è¦½</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç™¼å¸ƒè¨­å®š -->
        <div class="bg-white rounded-lg shadow p-6">
            <label class="flex items-center space-x-3">
                <input 
                    type="checkbox" 
                    id="is_published" 
                    name="is_published" 
                    value="1"
                    {% if post and post.is_published %}checked{% endif %}
                    class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                >
                <span class="text-sm font-medium text-gray-700">
                    ç«‹å³ç™¼å¸ƒï¼ˆå–æ¶ˆå‹¾é¸å‰‡å„²å­˜ç‚ºè‰ç¨¿ï¼‰
                </span>
            </label>
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="flex items-center justify-between">
            <a href="{{ url_for('posts.my_posts') }}" 
               class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors">
                å–æ¶ˆ
            </a>
            <div class="flex items-center space-x-3">
                <span id="saveStatus" class="text-sm text-gray-500"></span>
                <button type="submit" 
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                    {% if post %}æ›´æ–°æ–‡ç« {% else %}ç™¼å¸ƒæ–‡ç« {% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

<!-- åœ–ç‰‡ä¸Šå‚³ Modal -->
<div id="imageUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
        <h3 class="text-lg font-bold mb-4">ä¸Šå‚³åœ–ç‰‡</h3>
        <input type="file" id="imageFileInput" accept="image/*" class="w-full mb-4">
        <div class="flex justify-end space-x-3">
            <button type="button" onclick="closeImageModal()" 
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">
                å–æ¶ˆ
            </button>
            <button type="button" onclick="uploadImage()" 
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                ä¸Šå‚³
            </button>
        </div>
    </div>
</div>

<script>
// å…¨åŸŸè®Šæ•¸
let autoSaveTimer = null;
let contentTextarea = null;
let previewContent = null;
let previewPane = null;
let editorPane = null;

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    contentTextarea = document.getElementById('content');
    previewContent = document.getElementById('previewContent');
    previewPane = document.getElementById('previewPane');
    editorPane = document.getElementById('editorPane');
    
    if (!contentTextarea) {
        console.error('Editor textarea not found');
        return;
    }

    // ç­‰å¾… CDN è¼‰å…¥
    waitForCDN().then(() => {
        // ç¶å®šè¼¸å…¥äº‹ä»¶ - å³æ™‚æ›´æ–°é è¦½
        contentTextarea.addEventListener('input', function() {
            updateCharCount();
            updatePreview(); // æ¯æ¬¡è¼¸å…¥éƒ½æ›´æ–°é è¦½
            scheduleAutoSave();
        });

        // ç¶å®šå¿«æ·éµ
        contentTextarea.addEventListener('keydown', handleKeyboardShortcuts);

        // æ‹–æ‹½ä¸Šå‚³
        initializeDragDrop();

        // åˆå§‹å­—æ•¸çµ±è¨ˆ
        updateCharCount();

        // è¼‰å…¥è‰ç¨¿ï¼ˆåƒ…é™æ–°æ–‡ç« ï¼‰
        {% if not post %}
        loadDraft();
        {% endif %}

        // å¦‚æœæœ‰å…§å®¹ï¼Œç«‹å³åˆå§‹åŒ–é è¦½
        if (contentTextarea.value.trim()) {
            updatePreview();
        }
    });
});

// ç­‰å¾… CDN åº«è¼‰å…¥
function waitForCDN() {
    return new Promise((resolve) => {
        let attempts = 0;
        const maxAttempts = 10;
        
        const checkCDN = () => {
            if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                // é…ç½® marked
                if (marked.setOptions) {
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        headerIds: true,
                        mangle: false,
                        sanitize: false,
                        smartLists: true,
                        smartypants: false
                    });
                }
                resolve(true);
            } else {
                attempts++;
                if (attempts < maxAttempts) {
                    setTimeout(checkCDN, 200);
                } else {
                    console.error('CDN libraries failed to load');
                    showToast('Markdown è§£æå™¨è¼‰å…¥å¤±æ•—ï¼Œé è¦½åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨', 'error');
                    resolve(false);
                }
            }
        };
        
        checkCDN();
    });
}

// æ›´æ–°é è¦½
function updatePreview() {
    if (!previewContent || typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
        return;
    }

    const content = contentTextarea.value.trim();

    if (!content) {
        previewContent.innerHTML = `
            <div class="text-center py-12 text-gray-400">
                <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="text-lg">é–‹å§‹è¼¸å…¥ä»¥æŸ¥çœ‹é è¦½</p>
            </div>
        `;
        return;
    }

    try {
        // è§£æ Markdown
        const rawHtml = marked.parse(content);
        
        // æ¸…ç† HTML
        const cleanHtml = DOMPurify.sanitize(rawHtml, {
            ALLOWED_TAGS: [
                'p', 'br', 'strong', 'em', 'u', 'del', 'mark',
                'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                'ul', 'ol', 'li', 'dl', 'dt', 'dd',
                'blockquote', 'pre', 'code',
                'a', 'img',
                'table', 'thead', 'tbody', 'tfoot', 'tr', 'th', 'td',
                'div', 'span', 'hr'
            ],
            ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id'],
            KEEP_CONTENT: true
        });

        previewContent.innerHTML = cleanHtml;

        // é«˜äº®ç¨‹å¼ç¢¼
        if (typeof hljs !== 'undefined') {
            previewContent.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        // å¤–éƒ¨é€£çµè¨­å®š
        previewContent.querySelectorAll('a').forEach((link) => {
            if (link.hostname !== window.location.hostname) {
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
            }
        });

    } catch (error) {
        console.error('Preview update error:', error);
        previewContent.innerHTML = `
            <div class="text-center py-12 text-red-500">
                <p class="text-lg font-medium">é è¦½è§£æéŒ¯èª¤</p>
                <p class="text-sm mt-2">${error.message}</p>
            </div>
        `;
    }
}

// æ›´æ–°å­—æ•¸çµ±è¨ˆ
function updateCharCount() {
    const charCount = document.getElementById('charCount');
    if (charCount && contentTextarea) {
        const count = contentTextarea.value.length;
        charCount.textContent = count.toLocaleString();
    }
}

// æ’å…¥ Markdown æ¨™è¨˜
function insertMarkdown(before, after, placeholder) {
    const start = contentTextarea.selectionStart;
    const end = contentTextarea.selectionEnd;
    const selectedText = contentTextarea.value.substring(start, end);
    const textToInsert = selectedText || placeholder;
    const newText = before + textToInsert + after;
    
    contentTextarea.setRangeText(newText, start, end, 'end');
    contentTextarea.focus();
    
    // å¦‚æœæ²’æœ‰é¸å–æ–‡å­—ï¼Œé¸ä¸­æ’å…¥çš„ placeholder
    if (!selectedText) {
        contentTextarea.setSelectionRange(start + before.length, start + before.length + placeholder.length);
    }
    
    contentTextarea.dispatchEvent(new Event('input'));
}

// æ’å…¥é€£çµ
function insertLink() {
    const url = prompt('è«‹è¼¸å…¥é€£çµç¶²å€ï¼š');
    if (url) {
        const start = contentTextarea.selectionStart;
        const end = contentTextarea.selectionEnd;
        const selectedText = contentTextarea.value.substring(start, end) || 'é€£çµæ–‡å­—';
        const linkText = `[${selectedText}](${url})`;
        
        contentTextarea.setRangeText(linkText, start, end, 'end');
        contentTextarea.focus();
        contentTextarea.dispatchEvent(new Event('input'));
    }
}

// æ’å…¥åœ–ç‰‡
function insertImage() {
    document.getElementById('imageUploadModal').classList.remove('hidden');
}

// é—œé–‰åœ–ç‰‡ Modal
function closeImageModal() {
    document.getElementById('imageUploadModal').classList.add('hidden');
    document.getElementById('imageFileInput').value = '';
}

// ä¸Šå‚³åœ–ç‰‡
function uploadImage() {
    const fileInput = document.getElementById('imageFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ', 'warning');
        return;
    }

    if (!file.type.startsWith('image/')) {
        showToast('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('image', file);

    const uploadBtn = event.target;
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'ä¸Šå‚³ä¸­...';

    fetch('/posts/upload-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 0) {
            const imageUrl = data.data.url;
            const imageMarkdown = `![${file.name}](${imageUrl})`;
            
            const pos = contentTextarea.selectionStart;
            contentTextarea.setRangeText(imageMarkdown, pos, pos, 'end');
            contentTextarea.focus();
            contentTextarea.dispatchEvent(new Event('input'));
            
            showToast('åœ–ç‰‡ä¸Šå‚³æˆåŠŸ', 'success');
            closeImageModal();
        } else {
            showToast(data.message || 'ä¸Šå‚³å¤±æ•—', 'error');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showToast('ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦', 'error');
    })
    .finally(() => {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'ä¸Šå‚³';
    });
}

// æ’å…¥æ¨™é¡Œ
function insertHeading() {
    const level = prompt('è«‹è¼¸å…¥æ¨™é¡Œç´šåˆ¥ (1-6):', '2');
    if (level && /^[1-6]$/.test(level)) {
        const heading = '#'.repeat(parseInt(level)) + ' ';
        const start = contentTextarea.selectionStart;
        contentTextarea.setRangeText(heading, start, start, 'end');
        contentTextarea.focus();
        contentTextarea.dispatchEvent(new Event('input'));
    }
}

// æ’å…¥æ¸…å–®
function insertList() {
    const type = confirm('ç¢ºå®šå»ºç«‹æœ‰åºæ¸…å–®ï¼Ÿå–æ¶ˆå‰‡å»ºç«‹ç„¡åºæ¸…å–®');
    const prefix = type ? '1. ' : '- ';
    const start = contentTextarea.selectionStart;
    contentTextarea.setRangeText(prefix, start, start, 'end');
    contentTextarea.focus();
    contentTextarea.dispatchEvent(new Event('input'));
}

// éµç›¤å¿«æ·éµ
function handleKeyboardShortcuts(e) {
    // Ctrl/Cmd + B = ç²—é«”
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        insertMarkdown('**', '**', 'ç²—é«”æ–‡å­—');
    }
    
    // Ctrl/Cmd + I = æ–œé«”
    if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
        e.preventDefault();
        insertMarkdown('*', '*', 'æ–œé«”æ–‡å­—');
    }
    
    // Ctrl/Cmd + K = é€£çµ
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        insertLink();
    }
}

// æ‹–æ‹½ä¸Šå‚³åˆå§‹åŒ–
function initializeDragDrop() {
    const editorPane = document.getElementById('editorPane');
    
    editorPane.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        editorPane.classList.add('drag-over');
    });
    
    editorPane.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        editorPane.classList.remove('drag-over');
    });
    
    editorPane.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        editorPane.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
            uploadDroppedImage(files[0]);
        }
    });
}

// ä¸Šå‚³æ‹–æ”¾çš„åœ–ç‰‡
function uploadDroppedImage(file) {
    const formData = new FormData();
    formData.append('image', file);

    showToast('ä¸Šå‚³ä¸­...', 'info');

    fetch('/posts/upload-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 0) {
            const imageUrl = data.data.url;
            const imageMarkdown = `![${file.name}](${imageUrl})`;
            
            const pos = contentTextarea.selectionStart;
            contentTextarea.setRangeText(imageMarkdown, pos, pos, 'end');
            contentTextarea.focus();
            contentTextarea.dispatchEvent(new Event('input'));
            
            showToast('åœ–ç‰‡ä¸Šå‚³æˆåŠŸ', 'success');
        } else {
            showToast(data.message || 'ä¸Šå‚³å¤±æ•—', 'error');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showToast('ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦', 'error');
    });
}

// è‡ªå‹•å„²å­˜
function scheduleAutoSave() {
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    
    const saveStatus = document.getElementById('saveStatus');
    if (saveStatus) {
        saveStatus.textContent = 'æœªå„²å­˜';
        saveStatus.className = 'text-sm text-gray-400';
    }
    
    autoSaveTimer = setTimeout(() => {
        // å„²å­˜åˆ° localStorage
        const draftData = {
            title: document.getElementById('title').value,
            content: contentTextarea.value,
            category: document.getElementById('category').value,
            timestamp: new Date().toISOString()
        };
        
        try {
            localStorage.setItem('post_draft', JSON.stringify(draftData));
            
            if (saveStatus) {
                saveStatus.textContent = 'å·²è‡ªå‹•å„²å­˜';
                saveStatus.className = 'text-sm text-green-600';
                
                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 3000);
            }
        } catch (error) {
            console.error('Auto-save error:', error);
        }
    }, 3000);
}

// è¼‰å…¥è‰ç¨¿
function loadDraft() {
    try {
        const draftData = localStorage.getItem('post_draft');
        if (draftData) {
            const draft = JSON.parse(draftData);
            const draftTime = new Date(draft.timestamp);
            const now = new Date();
            const hoursDiff = (now - draftTime) / (1000 * 60 * 60);
            
            // åªè¼‰å…¥ 24 å°æ™‚å…§çš„è‰ç¨¿
            if (hoursDiff < 24) {
                const confirm = window.confirm(
                    `ç™¼ç¾æœªå®Œæˆçš„è‰ç¨¿ï¼ˆ${draftTime.toLocaleString()}ï¼‰\n` +
                    `æ˜¯å¦è¼‰å…¥ï¼Ÿ\n\n` +
                    `æ¨™é¡Œ: ${draft.title || 'ï¼ˆç„¡æ¨™é¡Œï¼‰'}`
                );
                
                if (confirm) {
                    document.getElementById('title').value = draft.title || '';
                    contentTextarea.value = draft.content || '';
                    document.getElementById('category').value = draft.category || '';
                    
                    updateCharCount();
                    if (isPreviewMode) {
                        updatePreview();
                    }
                    
                    showToast('è‰ç¨¿å·²è¼‰å…¥', 'success');
                }
            }
        }
    } catch (error) {
        console.error('Load draft error:', error);
    }
}

// æ¸…é™¤è‰ç¨¿
function clearDraft() {
    try {
        localStorage.removeItem('post_draft');
    } catch (error) {
        console.error('Clear draft error:', error);
    }
}

// Toast é€šçŸ¥
function showToast(message, type = 'info', duration = 3000) {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    const colors = {
        success: 'border-l-4 border-green-500',
        error: 'border-l-4 border-red-500',
        warning: 'border-l-4 border-yellow-500',
        info: 'border-l-4 border-blue-500'
    };
    
    const icons = {
        success: 'âœ“',
        error: 'âœ•',
        warning: 'âš ',
        info: 'â„¹'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast ${colors[type]}`;
    toast.innerHTML = `
        <div class="flex items-center">
            <span class="text-2xl mr-3">${icons[type]}</span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// è¡¨å–®æäº¤å‰é©—è­‰
document.getElementById('postForm').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const content = contentTextarea.value.trim();
    
    if (!title) {
        e.preventDefault();
        showToast('è«‹è¼¸å…¥æ–‡ç« æ¨™é¡Œ', 'warning');
        return false;
    }
    
    if (!content) {
        e.preventDefault();
        showToast('è«‹è¼¸å…¥æ–‡ç« å…§å®¹', 'warning');
        return false;
    }
    
    // æ¸…é™¤è‰ç¨¿ï¼ˆå› ç‚ºå³å°‡å„²å­˜åˆ°ä¼ºæœå™¨ï¼‰
    clearDraft();
    
    return true;
});
</script>
{% endblock %}
