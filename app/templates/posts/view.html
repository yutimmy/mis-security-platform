{% extends "layouts/base.html" %}

{% block title %}{{ post.title }} - 資安情訊平臺{% endblock %}

{% block extra_head %}
<!-- Markdown 渲染相關 CDN -->
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
<style>
.markdown-content {
    line-height: 1.8;
    color: #374151;
}
.markdown-content h1 { 
    font-size: 2rem; 
    font-weight: bold; 
    margin: 2rem 0 1rem 0; 
    color: #111827;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 0.5rem;
}
.markdown-content h2 { 
    font-size: 1.5rem; 
    font-weight: bold; 
    margin: 1.5rem 0 0.75rem 0; 
    color: #1f2937;
}
.markdown-content h3 { 
    font-size: 1.25rem; 
    font-weight: bold; 
    margin: 1.25rem 0 0.5rem 0; 
    color: #374151;
}
.markdown-content p { 
    margin-bottom: 1.25rem; 
}
.markdown-content ul, .markdown-content ol { 
    margin-bottom: 1.25rem; 
    padding-left: 1.5rem; 
}
.markdown-content li { 
    margin-bottom: 0.5rem; 
}
.markdown-content code { 
    background-color: #f3f4f6; 
    color: #e11d48;
    padding: 0.125rem 0.375rem; 
    border-radius: 0.25rem; 
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
}
.markdown-content pre { 
    background-color: #1f2937; 
    color: #f9fafb; 
    padding: 1.25rem; 
    border-radius: 0.5rem; 
    overflow-x: auto; 
    margin: 1.5rem 0;
    border: 1px solid #374151;
}
.markdown-content pre code {
    background-color: transparent;
    color: inherit;
    padding: 0;
}
.markdown-content blockquote { 
    border-left: 4px solid #3b82f6; 
    padding-left: 1.25rem; 
    margin: 1.5rem 0; 
    font-style: italic;
    background-color: #f8fafc;
    padding: 1rem 1.25rem;
    border-radius: 0.375rem;
}
.markdown-content img { 
    max-width: 100%; 
    height: auto; 
    border-radius: 0.5rem; 
    margin: 1.5rem 0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.markdown-content table { 
    width: 100%; 
    border-collapse: collapse; 
    margin: 1.5rem 0;
    background-color: white;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}
.markdown-content th, .markdown-content td { 
    border: 1px solid #e5e7eb; 
    padding: 0.75rem; 
    text-align: left; 
}
.markdown-content th { 
    background-color: #f9fafb; 
    font-weight: 600;
    color: #374151;
}
.markdown-content a {
    color: #3b82f6;
    text-decoration: underline;
}
.markdown-content a:hover {
    color: #1d4ed8;
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- 文章頭部資訊 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('posts.index') }}" 
                       class="text-blue-600 hover:text-blue-800 flex items-center">
                        ← 返回文章列表
                    </a>
                    {% if session.user_id == post.author_id or (session.user_id and session.user_role == 'admin') %}
                        <a href="{{ url_for('posts.edit', post_id=post.id) }}" 
                           class="text-green-600 hover:text-green-800 flex items-center">
                            ✏️ 編輯文章
                        </a>
                    {% endif %}
                </div>
                
                {% if not post.is_published %}
                    <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded">
                        草稿
                    </span>
                {% endif %}
            </div>
            
            <!-- 文章標題 -->
            <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>
            
            <!-- 文章元資訊 -->
            <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 border-b border-gray-200 pb-4">
                <div class="flex items-center">
                    <span class="font-medium">作者：</span>
                    <span class="ml-1">{{ post.author.username if post.author else '未知' }}</span>
                </div>
                
                {% if post.category %}
                <div class="flex items-center">
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded">
                        {{ post.category }}
                    </span>
                </div>
                {% endif %}
                
                <div class="flex items-center">
                    <span class="font-medium">發布時間：</span>
                    <span class="ml-1">{{ post.created_at.strftime('%Y-%m-%d') if post.created_at else '' }}</span>
                </div>
                
                {% if post.updated_at != post.created_at %}
                <div class="flex items-center">
                    <span class="font-medium">更新時間：</span>
                    <span class="ml-1">{{ post.updated_at.strftime('%Y-%m-%d') if post.updated_at else '' }}</span>
                </div>
                {% endif %}
                
                <div class="flex items-center">
                    <span class="font-medium">觀看次數：</span>
                    <span class="ml-1">{{ post.views or 0 }}</span>
                </div>
            </div>
        </div>
        
        <!-- 文章內容 -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <div class="markdown-content" id="markdown-content">
                <!-- Markdown 內容將由 JavaScript 渲染 -->
            </div>
        </div>
        
        <!-- 操作按鈕 -->
        {% if session.user_id == post.author_id or (session.user_id and session.user_role == 'admin') %}
        <div class="mt-6 flex justify-end space-x-4">
            <a href="{{ url_for('posts.edit', post_id=post.id) }}" 
               class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                編輯文章
            </a>
            <button onclick="deletePost({{ post.id }})" 
                    class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                刪除文章
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- 刪除確認 Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg font-medium text-gray-900">確認刪除</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">確定要刪除這篇文章嗎？此操作無法復原。</p>
            </div>
            <div class="items-center px-4 py-3 flex justify-center space-x-4">
                <button onclick="hideDeleteModal()" 
                        class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-400">
                    取消
                </button>
                <button onclick="confirmDelete()" 
                        class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700">
                    確認刪除
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 渲染 Markdown 內容
document.addEventListener('DOMContentLoaded', function() {
    const markdownContent = {{ post.content|tojson|safe }};
    const contentContainer = document.getElementById('markdown-content');
    
    if (markdownContent) {
        // 配置 marked
        marked.setOptions({
            highlight: function(code, lang) {
                return code; // 簡單處理，可以後續整合語法高亮
            },
            breaks: true,
            gfm: true
        });
        
        // 轉換 Markdown 為 HTML
        const rawHtml = marked.parse(markdownContent);
        
        // 使用 DOMPurify 清理 HTML
        const cleanHtml = DOMPurify.sanitize(rawHtml);
        
        // 插入清理後的 HTML
        contentContainer.innerHTML = cleanHtml;
    } else {
        contentContainer.innerHTML = '<p class="text-gray-500 italic">此文章暫無內容</p>';
    }
});

let postIdToDelete = null;

function deletePost(postId) {
    postIdToDelete = postId;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function hideDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    postIdToDelete = null;
}

function confirmDelete() {
    if (!postIdToDelete) return;
    
    fetch(`/posts/${postIdToDelete}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken() // 如果有 CSRF 保護
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 0) {
            alert('文章已成功刪除');
            window.location.href = '{{ url_for("posts.index") }}';
        } else {
            alert('刪除失敗：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('刪除時發生錯誤');
    })
    .finally(() => {
        hideDeleteModal();
    });
}

// 簡單的 CSRF Token 獲取函數（如果需要）
function getCsrfToken() {
    // 這裡可以從 meta tag 或其他地方獲取 CSRF token
    // 暫時返回空字串
    return '';
}
</script>
{% endblock %}
