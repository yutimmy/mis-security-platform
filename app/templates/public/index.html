{% extends "layouts/base.html" %}

{% block title %}æ–°èåˆ—è¡¨ - è³‡å®‰æƒ…è¨Šå¹³è‡º{% endblock %}

{% block content %}
<!-- ä¸»å®¹å™¨ - å…¨å¯¬è¨­è¨ˆ -->
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
    <div class="w-full px-4 py-6 lg:py-8">
        <!-- é é¢æ¨™é¡Œå€ -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">
                ğŸ”’ æœ€æ–°è³‡å®‰æƒ…è¨Š
            </h1>
            <p class="text-gray-600 text-lg">æŒæ¡æœ€æ–°çš„è³‡å®‰å‹•æ…‹èˆ‡å¨è„…æƒ…å ±</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- å·¦å´æœå°‹æ¬„ - å›ºå®šå¯¬åº¦ï¼Œæ‰‹æ©Ÿç‰ˆå¯æ‘ºç–Š -->
            <div class="w-full lg:w-80 lg:flex-shrink-0">
                <!-- æ‰‹æ©Ÿç‰ˆæ‘ºç–ŠæŒ‰éˆ• -->
                <div class="lg:hidden mb-4">
                    <button id="mobile-filter-toggle" class="w-full bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white font-medium py-3 px-4 rounded-xl transition-all duration-200 flex items-center justify-center shadow-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        æœå°‹èˆ‡ç¯©é¸
                    </button>
                </div>
                
                <div id="search-panel" class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 sticky top-24 hidden lg:block">
                    <h3 class="text-lg font-semibold mb-6 text-gray-900 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        æœå°‹ç¯©é¸
                    </h3>
                    
                    <form method="GET" action="{{ url_for('public.index') }}" class="space-y-5">
                        <!-- æœå°‹æ¡† -->
                        <div>
                            <label for="search" class="block text-sm font-medium text-gray-700 mb-2">é—œéµå­—æœå°‹</label>
                            <div class="relative">
                                <input type="text" id="search" name="q" value="{{ search_query }}" 
                                       placeholder="æœå°‹æ¨™é¡Œã€å…§å®¹ã€CVE..." 
                                       class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- ä¾†æºç¯©é¸ -->
                        <div>
                            <label for="source" class="block text-sm font-medium text-gray-700 mb-2">æ–°èä¾†æº</label>
                            <select id="source" name="source" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                                <option value="">å…¨éƒ¨ä¾†æº</option>
                                {% for source in sources %}
                                    <option value="{{ source.source }}" {% if current_source == source.source %}selected{% endif %}>
                                        {{ source.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- æ—¥æœŸç¯©é¸ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸç¯„åœ</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" name="date_from" class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="date" name="date_to" class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div class="flex flex-col gap-2">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-xl transition-all duration-200 shadow-sm hover:shadow-md">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                æœå°‹
                            </button>
                            <a href="{{ url_for('public.index') }}" class="w-full text-center bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-xl transition-all duration-200 text-sm">
                                æ¸…é™¤ç¯©é¸
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- æ–°èåˆ—è¡¨ -->
            <div class="lg:w-3/4">
                <!-- çµ±è¨ˆè³‡è¨Š -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                        <div class="flex items-center space-x-4">
                            <div class="bg-blue-100 p-3 rounded-xl">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-2xl lg:text-3xl font-bold text-gray-900">{{ news_list.total }}</h2>
                                <p class="text-gray-600">å‰‡æœ€æ–°è³‡å®‰æ–°è</p>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 bg-gray-50 px-4 py-2 rounded-xl">
                            ç¬¬ {{ news_list.page }} / {{ news_list.pages }} é 
                        </div>
                    </div>
                </div>
                
                <!-- æ–°èå¡ç‰‡ç¶²æ ¼åˆ—è¡¨ - 3å€‹ä¸€åˆ— -->
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 lg:gap-6">
                    {% for news in news_list.items %}
                        <article class="bg-white rounded-2xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300 overflow-hidden group h-full flex flex-col">
                            <!-- æ–°èæ¨™é¡Œå€ -->
                            <div class="p-4 pb-3 flex-1 flex flex-col">
                                <!-- æ¨™é¡Œ -->
                                <h2 class="text-base lg:text-lg font-bold text-gray-900 mb-2 line-clamp-2 group-hover:text-blue-600 transition-colors">
                                    <a href="{{ url_for('public.news_detail', news_id=news.id) }}" class="hover:underline">
                                        {{ news.title or 'ç„¡æ¨™é¡Œ' }}
                                    </a>
                                </h2>
                                
                                <!-- å…ƒè³‡è¨Šèˆ‡æ¨™ç±¤å€ -->
                                <div class="flex flex-col gap-2 mb-3">
                                    <!-- åŸºæœ¬è³‡è¨Š -->
                                    <div class="flex flex-wrap items-center gap-1">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 011 1v1m2-1h2a2 2 0 012 2v10a2 2 0 01-2 2h-2m-2-4V9a2 2 0 00-2-2H7a2 2 0 00-2 2v2m3 4a3 3 0 100-6 3 3 0 000 6z"></path>
                                            </svg>
                                            {{ news.source }}
                                        </span>
                                        <span class="inline-flex items-center text-xs text-gray-500">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a1 1 0 012-2h4a1 1 0 012 2v4h3a2 2 0 012 2v1a1 1 0 01-1 1v-1a2 2 0 00-2-2H6a2 2 0 00-2 2v1a1 1 0 01-1-1V9a2 2 0 012-2h3z"></path>
                                            </svg>
                                            {{ news.created_at.strftime('%mæœˆ%dæ—¥') if news.created_at else '' }}
                                        </span>
                                        {% if news.ai_content %}
                                            <span class="inline-flex items-center px-1.5 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                </svg>
                                                AI
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- CVE æ¨™ç±¤å€ -->
                                    {% if news.cve_id %}
                                        {% set cve_list = news.cve_id.split(',') %}
                                        <div class="flex flex-wrap gap-1">
                                            {% for cve in cve_list[:2] %}
                                                <span class="inline-flex items-center px-1.5 py-0.5 bg-red-100 text-red-800 rounded text-xs font-bold">
                                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 14.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                                    </svg>
                                                    {{ cve.strip() }}
                                                </span>
                                            {% endfor %}
                                            {% if cve_list|length > 2 %}
                                                <span class="inline-flex items-center px-1.5 py-0.5 bg-gray-100 text-gray-700 rounded text-xs font-medium">
                                                    +{{ cve_list|length - 2 }}
                                                </span>
                                            {% endif %}
                                            {% if news.poc_link %}
                                                <span class="inline-flex items-center px-1.5 py-0.5 bg-green-100 text-green-800 rounded text-xs font-bold">
                                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    POC
                                                </span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- å…§å®¹é è¦½ -->
                                {% if news.content %}
                                    <div class="bg-gray-50 rounded-lg p-3 mb-3 flex-1">
                                        <p class="text-gray-700 text-sm leading-relaxed line-clamp-3">
                                            {{ news.content[:120] }}{% if news.content|length > 120 %}...{% endif %}
                                        </p>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- åº•éƒ¨æ“ä½œå€ -->
                            <div class="px-4 py-3 bg-gray-50 border-t border-gray-100 mt-auto">
                                <div class="flex flex-col gap-2">
                                    <div class="flex gap-2">
                                        <a href="{{ url_for('public.news_detail', news_id=news.id) }}" 
                                           class="inline-flex items-center justify-center px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-200 shadow-sm hover:shadow-md font-medium text-sm flex-1">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                            è©³æƒ…
                                        </a>
                                        
                                        <a href="{{ news.link }}" target="_blank" 
                                           class="inline-flex items-center justify-center px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-all duration-200 font-medium text-sm flex-1">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                            </svg>
                                            åŸæ–‡
                                        </a>
                                    </div>
                                    
                                    <!-- POC æŸ¥è©¢æŒ‰éˆ• -->
                                    {% if news.cve_id %}
                                        {% if session.user_id %}
                                            <button onclick="queryPOC({{ news.id }}, '{{ news.cve_id }}')" 
                                                    class="inline-flex items-center justify-center px-3 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 hover:text-orange-800 rounded-lg transition-all duration-200 font-medium text-sm w-full"
                                                    id="poc-btn-{{ news.id }}">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                </svg>
                                                æŸ¥è©¢ POC
                                            </button>
                                        {% else %}
                                            <button class="inline-flex items-center justify-center px-3 py-2 bg-gray-100 text-gray-400 rounded-lg cursor-not-allowed text-sm w-full" 
                                                    title="è«‹å…ˆç™»å…¥">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                                </svg>
                                                æŸ¥è©¢ POC
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </article>
                    {% else %}
                        <!-- ç©ºç‹€æ…‹ -->
                        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-12 text-center">
                            <div class="mb-6">
                                <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">æš«ç„¡ç›¸é—œæ–°è</h3>
                            <p class="text-gray-600 mb-6">
                                {% if search_query or current_source %}
                                    æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ–°èï¼Œè«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶
                                {% else %}
                                    ç›®å‰é‚„æ²’æœ‰ä»»ä½•æ–°èï¼Œè«‹ç¨å¾Œå†ä¾†æŸ¥çœ‹
                                {% endif %}
                            </p>
                            {% if search_query or current_source %}
                                <a href="{{ url_for('public.index') }}" class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all duration-200 shadow-sm hover:shadow-md font-medium">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    è¿”å›æ‰€æœ‰æ–°è
                                </a>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <!-- åˆ†é å°èˆª -->
                {% if news_list.pages > 1 %}
                    <div class="mt-12">
                        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                                <!-- åˆ†é è³‡è¨Š -->
                                <div class="text-sm text-gray-600">
                                    é¡¯ç¤ºç¬¬ {{ (news_list.page - 1) * news_list.per_page + 1 }} - 
                                    {{ news_list.page * news_list.per_page if news_list.page * news_list.per_page < news_list.total else news_list.total }} å‰‡ï¼Œ
                                    å…± {{ news_list.total }} å‰‡æ–°è
                                </div>
                                
                                <!-- åˆ†é æŒ‰éˆ• -->
                                <div class="flex flex-wrap justify-center gap-2">
                                    {% if news_list.has_prev %}
                                        <a href="{{ url_for('public.index', page=1, source=current_source, q=search_query) }}" 
                                           class="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-all duration-200 font-medium">
                                            ç¬¬ä¸€é 
                                        </a>
                                        <a href="{{ url_for('public.index', page=news_list.prev_num, source=current_source, q=search_query) }}" 
                                           class="px-4 py-2 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-xl transition-all duration-200 font-medium">
                                            â† ä¸Šä¸€é 
                                        </a>
                                    {% endif %}
                                    
                                    {% for page_num in news_list.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                        {% if page_num %}
                                            {% if page_num != news_list.page %}
                                                <a href="{{ url_for('public.index', page=page_num, source=current_source, q=search_query) }}" 
                                                   class="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-all duration-200 font-medium hidden sm:block">
                                                    {{ page_num }}
                                                </a>
                                            {% else %}
                                                <span class="px-4 py-2 text-sm bg-blue-600 text-white rounded-xl font-bold shadow-md">
                                                    {{ page_num }}
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="px-2 py-2 text-sm text-gray-400 hidden sm:block">â€¦</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if news_list.has_next %}
                                        <a href="{{ url_for('public.index', page=news_list.next_num, source=current_source, q=search_query) }}" 
                                           class="px-4 py-2 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-xl transition-all duration-200 font-medium">
                                            ä¸‹ä¸€é  â†’
                                        </a>
                                        <a href="{{ url_for('public.index', page=news_list.pages, source=current_source, q=search_query) }}" 
                                           class="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-all duration-200 font-medium">
                                            æœ€å¾Œé 
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- POC é¸æ“‡ Modal -->
<div id="poc-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 p-4 backdrop-blur-sm">
    <div class="flex justify-center items-center min-h-screen">
        <div class="bg-white rounded-3xl max-w-lg w-full shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="poc-modal-content">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl lg:text-2xl font-bold text-gray-900 flex items-center">
                        <svg class="w-6 h-6 mr-3 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        é¸æ“‡æŸ¥è©¢ CVE
                    </h3>
                    <button onclick="closePOCModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <p class="text-gray-600 mt-2">è«‹é¸æ“‡è¦æŸ¥è©¢ POC çš„ CVE ç·¨è™Ÿ</p>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6">
                <div id="cve-list" class="space-y-3 mb-6 max-h-60 overflow-y-auto">
                    <!-- CVE é¸é …å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <!-- Modal Footer -->
                <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-gray-100">
                    <button onclick="closePOCModal()" class="w-full sm:flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-all duration-200 font-medium">
                        å–æ¶ˆ
                    </button>
                    <button onclick="submitPOCQuery()" class="w-full sm:flex-1 px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-xl transition-all duration-200 font-medium shadow-md hover:shadow-lg">
                        é–‹å§‹æŸ¥è©¢
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40 backdrop-blur-sm">
    <div class="flex justify-center items-center min-h-screen">
        <div class="bg-white rounded-2xl p-8 shadow-2xl text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-700 font-medium">æ­£åœ¨æŸ¥è©¢ POC...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // æ‰‹æ©Ÿç‰ˆæœå°‹é¢æ¿åˆ‡æ›
    const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
    const searchPanel = document.getElementById('search-panel');
    
    if (mobileFilterToggle && searchPanel) {
        mobileFilterToggle.addEventListener('click', function() {
            // åªåœ¨æ‰‹æ©Ÿç‰ˆåŸ·è¡Œåˆ‡æ›é‚è¼¯
            if (window.innerWidth < 1024) {
                const isHidden = searchPanel.classList.contains('hidden');
                
                if (isHidden) {
                    searchPanel.classList.remove('hidden');
                    searchPanel.classList.add('block');
                    
                    // æ·»åŠ å‹•ç•«æ•ˆæœ
                    setTimeout(() => {
                        searchPanel.style.opacity = '1';
                        searchPanel.style.transform = 'translateY(0)';
                    }, 10);
                    
                    mobileFilterToggle.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        é—œé–‰æœå°‹
                    `;
                } else {
                    searchPanel.style.opacity = '0';
                    searchPanel.style.transform = 'translateY(-10px)';
                    
                    setTimeout(() => {
                        searchPanel.classList.add('hidden');
                        searchPanel.classList.remove('block');
                    }, 200);
                    
                    mobileFilterToggle.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        æœå°‹èˆ‡ç¯©é¸
                    `;
                }
            }
        });
        
        // åˆå§‹åŒ–æœå°‹é¢æ¿æ¨£å¼ï¼ˆåƒ…åœ¨æ‰‹æ©Ÿç‰ˆï¼‰
        searchPanel.style.transition = 'opacity 0.2s ease-in-out, transform 0.2s ease-in-out';
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆï¼ˆlg æ–·é»ä»¥ä¸‹ï¼‰
        if (window.innerWidth < 1024) {
            // æ‰‹æ©Ÿç‰ˆï¼šç¢ºä¿éš±è—ç‹€æ…‹æ­£ç¢º
            searchPanel.classList.remove('block');
            searchPanel.style.opacity = '0';
            searchPanel.style.transform = 'translateY(-10px)';
            console.log('æœå°‹é¢æ¿åˆå§‹åŒ–ï¼šæ‰‹æ©Ÿç‰ˆæ¨¡å¼');
        } else {
            // æ¡Œé¢ç‰ˆï¼šæ¸…é™¤å¯èƒ½çš„æ‰‹æ©Ÿç‰ˆç‹€æ…‹ï¼Œè®“ Tailwind CSS æ§åˆ¶
            searchPanel.classList.remove('hidden', 'block');
            searchPanel.style.opacity = '';
            searchPanel.style.transform = '';
            console.log('æœå°‹é¢æ¿åˆå§‹åŒ–ï¼šæ¡Œé¢ç‰ˆæ¨¡å¼');
        }
        
        // çª—å£å¤§å°èª¿æ•´æ™‚é‡æ–°æª¢æŸ¥
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 1024) {
                // æ¡Œé¢ç‰ˆï¼šæ¸…é™¤æ‰‹æ©Ÿç‰ˆç‹€æ…‹ï¼Œè®“ Tailwind CSS æ§åˆ¶
                searchPanel.classList.remove('hidden', 'block');
                searchPanel.style.opacity = '';
                searchPanel.style.transform = '';
                
                // é‡ç½®æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•æ–‡å­—
                mobileFilterToggle.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    æœå°‹èˆ‡ç¯©é¸
                `;
            } else {
                // æ‰‹æ©Ÿç‰ˆï¼šç¢ºä¿éš±è—ç‹€æ…‹
                if (!searchPanel.classList.contains('block')) {
                    searchPanel.classList.add('hidden');
                    searchPanel.classList.remove('block');
                    searchPanel.style.opacity = '0';
                    searchPanel.style.transform = 'translateY(-10px)';
                }
            }
        });
    }
    
    // Modal å‹•ç•«åˆå§‹åŒ–
    const modalContent = document.getElementById('poc-modal-content');
    if (modalContent) {
        modalContent.style.transition = 'all 0.3s ease-in-out';
    }
});

let currentNewsId = null;

function queryPOC(newsId, cveString) {
    currentNewsId = newsId;
    const cveList = cveString.split(',').map(c => c.trim()).filter(c => c);
    
    if (cveList.length === 1) {
        // åªæœ‰ä¸€å€‹ CVEï¼Œç›´æ¥æŸ¥è©¢
        performPOCQuery(newsId, cveList);
    } else {
        // å¤šå€‹ CVEï¼Œé¡¯ç¤ºé¸æ“‡ modal
        showPOCModal(cveList);
    }
}

function showPOCModal(cveList) {
    const modal = document.getElementById('poc-modal');
    const modalContent = document.getElementById('poc-modal-content');
    const cveListDiv = document.getElementById('cve-list');
    
    cveListDiv.innerHTML = '';
    
    // å…¨é¸é¸é …
    const selectAllDiv = document.createElement('div');
    selectAllDiv.className = 'flex items-center p-3 bg-blue-50 rounded-xl border-2 border-blue-200';
    selectAllDiv.innerHTML = `
        <input type="checkbox" id="select-all" class="mr-3 w-5 h-5 text-blue-600 rounded focus:ring-blue-500" onchange="toggleAll(this)">
        <label for="select-all" class="font-bold text-blue-900 cursor-pointer flex-1">å…¨é¸æ‰€æœ‰ CVE</label>
    `;
    cveListDiv.appendChild(selectAllDiv);
    
    // å€‹åˆ¥ CVE é¸é …
    cveList.forEach((cve, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-xl border border-gray-200 transition-colors';
        div.innerHTML = `
            <input type="checkbox" id="cve-${index}" value="${cve}" class="mr-3 w-5 h-5 text-orange-600 rounded focus:ring-orange-500 cve-checkbox">
            <label for="cve-${index}" class="font-medium text-gray-900 cursor-pointer flex-1">${cve}</label>
            <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-bold">CVE</span>
        `;
        cveListDiv.appendChild(div);
    });
    
    // é¡¯ç¤º modal ä¸¦æ·»åŠ å‹•ç•«
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.style.opacity = '1';
        modalContent.style.transform = 'scale(1)';
    }, 10);
}

function closePOCModal() {
    const modal = document.getElementById('poc-modal');
    const modalContent = document.getElementById('poc-modal-content');
    
    modalContent.style.opacity = '0';
    modalContent.style.transform = 'scale(0.95)';
    
    setTimeout(() => {
        modal.classList.add('hidden');
        currentNewsId = null;
    }, 300);
}

function toggleAll(selectAllCheckbox) {
    const cveCheckboxes = document.querySelectorAll('.cve-checkbox');
    cveCheckboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
    });
}

function submitPOCQuery() {
    const selectedCVEs = Array.from(document.querySelectorAll('.cve-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selectedCVEs.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ CVE é€²è¡ŒæŸ¥è©¢');
        return;
    }
    
    closePOCModal();
    performPOCQuery(currentNewsId, selectedCVEs);
}

function performPOCQuery(newsId, cveList) {
    const btn = document.getElementById(`poc-btn-${newsId}`);
    const originalText = btn.innerHTML;
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // é¡¯ç¤º loading
    loadingOverlay.classList.remove('hidden');
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    btn.innerHTML = `
        <svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        æŸ¥è©¢ä¸­...
    `;
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    
    // ç™¼é€ API è«‹æ±‚
    fetch('/api/jobs/poc', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            news_id: newsId,
            cve_ids: cveList
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingOverlay.classList.add('hidden');
        
        if (data.code === 200) {
            // æˆåŠŸè¨Šæ¯
            let message = `ğŸ¯ POC æŸ¥è©¢å®Œæˆï¼\n\n`;
            message += `CVE: ${cveList.join(', ')}\n`;
            message += `ä»»å‹™ID: ${data.data.job_run_id}\n\n`;
            
            if (data.data.found && data.data.found.length > 0) {
                message += `âœ… æ‰¾åˆ° ${data.data.found.length} å€‹ CVE çš„ POC\n`;
                message += `ğŸ”— ç›¸é—œé€£çµå·²æ›´æ–°è‡³æ–°èè©³æƒ…é `;
                
                // é¡¯ç¤ºæˆåŠŸ toast
                showToast(message, 'success');
                
                // 3ç§’å¾Œé‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°é¡¯ç¤º
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } else {
                message += `âš ï¸ å¾ˆéºæ†¾ï¼Œæœªæ‰¾åˆ°ç›¸é—œçš„ POC\n`;
                message += `ğŸ’¡ å»ºè­°ç¨å¾Œå†è©¦æˆ–æŸ¥çœ‹å®˜æ–¹å®‰å…¨å…¬å‘Š`;
                showToast(message, 'warning');
            }
        } else {
            showToast(`âŒ æŸ¥è©¢å¤±æ•—: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        loadingOverlay.classList.add('hidden');
        showToast('âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦', 'error');
    })
    .finally(() => {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }, 2000);
    });
}

// Toast é€šçŸ¥å‡½æ•¸
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    const colors = {
        success: 'bg-green-600',
        warning: 'bg-yellow-600', 
        error: 'bg-red-600',
        info: 'bg-blue-600'
    };
    
    toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl z-50 max-w-md transform translate-x-full transition-transform duration-300`;
    toast.innerHTML = `
        <div class="flex items-start">
            <div class="flex-1">
                <pre class="whitespace-pre-wrap text-sm font-medium">${message}</pre>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // é¡¯ç¤ºå‹•ç•«
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 100);
    
    // è‡ªå‹•æ¶ˆå¤±
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 300);
    }, 8000);
}
</script>
{% endblock %}
