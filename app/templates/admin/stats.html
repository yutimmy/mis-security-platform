{% extends "layouts/base.html" %}

{% block title %}統計分析 - 管理後台{% endblock %}

{% block head %}
<!-- ApexCharts CDN - 更穩定的圖表庫 -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>
<!-- 額外圖標支援 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- 內嵌樣式 -->
<style>
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes slideUp {
    from { opacity: 0; transform: translateY(50px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
}
@keyframes glow {
    0%, 100% { box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    50% { box-shadow: 0 0 20px rgba(0,0,0,0.15), 0 0 30px rgba(0,0,0,0.1); }
}
.animate-fade-in { animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
.animate-slide-up { animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
.stat-card { 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}
.stat-card:hover { 
    transform: translateY(-6px) scale(1.02); 
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}
.stat-card:hover .stat-icon {
    transform: scale(1.1) rotate(5deg);
}
.stat-icon {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.chart-container {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}
.chart-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-white">
    <div class="container mx-auto px-4 py-6 sm:py-8">
        <!-- 頂部標題與控制區 -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 sm:p-8 shadow-sm mb-8 animate-fade-in">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                <div class="text-center lg:text-left">
                    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-black mb-2 sm:mb-3">
                        <i class="fas fa-chart-line mr-3 text-black"></i>
                        統計分析儀表板
                    </h1>
                    <p class="text-gray-700 text-base sm:text-lg font-medium">即時監控平台運行狀況與數據趨勢</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                    <button id="btn-refresh" onclick="refreshStats()" 
                            class="flex-1 sm:flex-none px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center font-medium group">
                        <i class="fas fa-sync-alt mr-2 group-hover:animate-spin"></i>
                        刷新數據
                    </button>
                    <button onclick="exportStats()" 
                            class="flex-1 sm:flex-none px-6 py-3 text-gray-700 hover:text-gray-900 border-2 border-gray-300 bg-white hover:bg-gray-50 rounded-xl transition-all duration-300 font-medium hover:shadow-lg transform hover:scale-105">
                        <i class="fas fa-download mr-2"></i>
                        匯出報表
                    </button>
                </div>
            </div>
        </div>

        <!-- 關鍵指標卡片區 -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 sm:gap-6 mb-8">
            <!-- 總新聞數 -->
            <div class="stat-card bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-300 relative overflow-hidden animate-slide-up" style="animation-delay: 0.1s">
                <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-blue-100 to-blue-50 rounded-full transform translate-x-6 -translate-y-6"></div>
                <div class="flex items-center justify-between mb-4 relative z-10">
                    <div class="stat-icon p-3 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg text-white">
                        <i class="fas fa-newspaper text-2xl"></i>
                    </div>
                    <div class="inline-flex items-center px-3 py-1 text-xs font-semibold text-blue-700 bg-blue-100 border border-blue-200 rounded-lg">
                        <i class="fas fa-chart-line mr-1"></i>
                        總計
                    </div>
                </div>
                <div class="relative z-10">
                    <h3 class="text-sm text-gray-500 font-medium mb-1">總新聞數</h3>
                    <p id="total-news" class="text-3xl font-bold text-black">{{ stats.total_news or 0 }}</p>
                    <div class="text-xs text-gray-400 mt-2">
                        <i class="fas fa-clock mr-1"></i>
                        即時統計
                    </div>
                </div>
            </div>

            <!-- RSS 來源數 -->
            <div class="stat-card bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-300 relative overflow-hidden animate-slide-up" style="animation-delay: 0.2s">
                <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-green-100 to-green-50 rounded-full transform translate-x-6 -translate-y-6"></div>
                <div class="flex items-center justify-between mb-4 relative z-10">
                    <div class="stat-icon p-3 bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg text-white">
                        <i class="fas fa-rss text-2xl"></i>
                    </div>
                    <div class="inline-flex items-center px-3 py-1 text-xs font-semibold text-green-700 bg-green-100 border border-green-200 rounded-lg">
                        <i class="fas fa-check-circle mr-1"></i>
                        來源
                    </div>
                </div>
                <div class="relative z-10">
                    <h3 class="text-sm text-gray-500 font-medium mb-1">RSS 來源數</h3>
                    <p id="total-sources" class="text-3xl font-bold text-black">{{ stats.total_sources or 0 }}</p>
                    <div class="text-xs text-gray-400 mt-2">
                        <i class="fas fa-globe mr-1"></i>
                        活躍來源
                    </div>
                </div>
            </div>

            <!-- 註冊用戶數 -->
            <div class="stat-card bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-300 relative overflow-hidden animate-slide-up" style="animation-delay: 0.3s">
                <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-purple-100 to-purple-50 rounded-full transform translate-x-6 -translate-y-6"></div>
                <div class="flex items-center justify-between mb-4 relative z-10">
                    <div class="stat-icon p-3 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg text-white">
                        <i class="fas fa-users text-2xl"></i>
                    </div>
                    <div class="inline-flex items-center px-3 py-1 text-xs font-semibold text-purple-700 bg-purple-100 border border-purple-200 rounded-lg">
                        <i class="fas fa-user-plus mr-1"></i>
                        用戶
                    </div>
                </div>
                <div class="relative z-10">
                    <h3 class="text-sm text-gray-500 font-medium mb-1">註冊用戶數</h3>
                    <p id="total-users" class="text-3xl font-bold text-black">{{ stats.total_users or 0 }}</p>
                    <div class="text-xs text-gray-400 mt-2">
                        <i class="fas fa-user-check mr-1"></i>
                        總用戶
                    </div>
                </div>
            </div>

            <!-- CVE 數量 -->
            <div class="stat-card bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-300 relative overflow-hidden animate-slide-up" style="animation-delay: 0.4s">
                <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-red-100 to-red-50 rounded-full transform translate-x-6 -translate-y-6"></div>
                <div class="flex items-center justify-between mb-4 relative z-10">
                    <div class="stat-icon p-3 bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg text-white">
                        <i class="fas fa-shield-alt text-2xl"></i>
                    </div>
                    <div class="inline-flex items-center px-3 py-1 text-xs font-semibold text-red-700 bg-red-100 border border-red-200 rounded-lg">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        CVE
                    </div>
                </div>
                <div class="relative z-10">
                    <h3 class="text-sm text-gray-500 font-medium mb-1">CVE 數量</h3>
                    <p id="total-cves" class="text-3xl font-bold text-black">{{ stats.total_cves or 0 }}</p>
                    <div class="text-xs text-gray-400 mt-2">
                        <i class="fas fa-bug mr-1"></i>
                        安全漏洞
                    </div>
                </div>
            </div>

            <!-- POC 覆蓋率 -->
            <div class="stat-card bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-300 relative overflow-hidden animate-slide-up" style="animation-delay: 0.5s">
                <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-orange-100 to-orange-50 rounded-full transform translate-x-6 -translate-y-6"></div>
                <div class="flex items-center justify-between mb-4 relative z-10">
                    <div class="stat-icon p-3 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg text-white">
                        <i class="fas fa-code text-2xl"></i>
                    </div>
                    <div class="inline-flex items-center px-3 py-1 text-xs font-semibold text-orange-700 bg-orange-100 border border-orange-200 rounded-lg">
                        <i class="fas fa-percentage mr-1"></i>
                        POC
                    </div>
                </div>
                <div class="relative z-10">
                    <h3 class="text-sm text-gray-500 font-medium mb-1">POC 覆蓋率</h3>
                    <p id="poc-coverage" class="text-3xl font-bold text-black">{{ stats.poc_coverage or '0%' }}</p>
                    <div class="mt-3">
                        <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div id="poc-progress" class="h-full bg-gradient-to-r from-orange-500 to-orange-400 rounded-full transition-all duration-1000 shadow-sm" 
                                 style="width: {{ stats.poc_coverage_percent or 0 }}%"></div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            <i class="fas fa-flask mr-1"></i>
                            實例代碼覆蓋
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 圖表區域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
            <!-- 新聞趨勢圖 -->
            <div class="chart-container bg-white rounded-xl p-6 border border-gray-200 shadow-sm animate-fade-in" style="animation-delay: 0.7s">
                <h5 class="text-lg font-semibold text-black mb-4 flex items-center">
                    <div class="w-3 h-3 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full mr-3"></div>
                    新聞趨勢
                </h5>
                <div id="chart-news-trend" style="height: 280px;"></div>
            </div>

            <!-- 來源排行圖 -->
            <div class="chart-container bg-white rounded-xl p-6 border border-gray-200 shadow-sm animate-fade-in" style="animation-delay: 0.8s">
                <h5 class="text-lg font-semibold text-black mb-4 flex items-center">
                    <div class="w-3 h-3 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full mr-3"></div>
                    熱門來源
                </h5>
                <div id="chart-top-sources" style="height: 280px;"></div>
            </div>

            <!-- CVE 分布圖 -->
            <div class="chart-container bg-white rounded-xl p-6 border border-gray-200 shadow-sm animate-fade-in lg:col-span-2 xl:col-span-1" style="animation-delay: 0.9s">
                <h5 class="text-lg font-semibold text-black mb-4 flex items-center">
                    <div class="w-3 h-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full mr-3"></div>
                    CVE 類別分布
                </h5>
                <div id="chart-cve-distribution" style="height: 280px;"></div>
            </div>
        </div>

        <!-- 近期事件清單 -->
        <div class="animate-fade-in" style="animation-delay: 0.6s">
            <div class="flex items-center justify-between mb-6">
                <h4 class="text-xl sm:text-2xl font-semibold text-black flex items-center">
                    <i class="fas fa-history text-black mr-3"></i>
                    近期 Job 執行紀錄
                </h4>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-clock mr-1"></i>
                    最新 10 筆
                </div>
            </div>
            <div id="recent-jobs" class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                {% if jobs %}
                    <div class="divide-y divide-gray-100">
                        {% for job in jobs[:10] %}
                        <div class="p-4 sm:p-6 hover:bg-gray-50 transition-all duration-200">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                <div class="flex items-center space-x-4">
                                    <div class="flex-shrink-0">
                                        {% if job.status == 'success' %}
                                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                        {% elif job.status == 'failed' %}
                                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                        {% elif job.status == 'running' %}
                                            <div class="w-3 h-3 bg-blue-500 rounded-full animate-ping"></div>
                                        {% else %}
                                            <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="font-medium text-black">
                                            {{ job.job_type|upper }}
                                            {% if job.target %}({{ job.target }}){% endif %}
                                        </div>
                                        <div class="text-sm text-gray-500 flex items-center mt-1">
                                            <span>狀態: {{ job.status }}</span>
                                            {% if job.inserted_count %}
                                                <span class="ml-3">新增: {{ job.inserted_count }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-400">
                                    {{ job.started_at.strftime('%Y-%m-%d %H:%M') if job.started_at else 'N/A' }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>暫無任務執行記錄</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- 底部版權與提示 -->
        <div class="mt-12 text-center text-gray-600 text-sm">
            <div class="flex items-center justify-center space-x-4">
                <i class="fas fa-chart-bar"></i>
                <span>數據每 30 秒自動更新</span>
                <i class="fas fa-sync-alt animate-spin"></i>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// 將伺服器端數據轉換為 JS 變數
const monthlyLabels = {{ monthly_labels|tojson | safe if monthly_labels is defined else '[]' }};
const monthlyCounts = {{ monthly_counts|tojson | safe if monthly_counts is defined else '[]' }};
const topSourcesLabels = {{ top_sources_labels|tojson | safe if top_sources_labels is defined else '[]' }};
const topSourcesCounts = {{ top_sources_counts|tojson | safe if top_sources_counts is defined else '[]' }};
const cveLabels = {{ cve_labels|tojson | safe if cve_labels is defined else '[]' }};
const cveCounts = {{ cve_counts|tojson | safe if cve_counts is defined else '[]' }};

let chartNews, chartSources, chartCve;
let refreshInterval;

// Helper: 動態載入 ApexCharts（若尚未載入）
function loadApexCharts(onLoaded) {
    if (typeof ApexCharts !== 'undefined') {
        onLoaded && onLoaded();
        return;
    }
    // 若已經存在正在載入的 script，監聽其 onload
    const existing = document.querySelector('script[data-apex-dynamic]');
    if (existing) {
        existing.addEventListener('load', function() {
            onLoaded && onLoaded();
        });
        existing.addEventListener('error', function() {
            console.error('動態載入 ApexCharts 失敗');
            showNotification('圖表庫載入失敗，部分功能可能無法正常使用', 'error');
        });
        return;
    }

    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js';
    script.setAttribute('data-apex-dynamic', '1');
    script.onload = function() {
        console.log('ApexCharts 動態載入完成');
        onLoaded && onLoaded();
    };
    script.onerror = function() {
        console.error('ApexCharts 動態載入失敗');
        showNotification('圖表庫載入失敗，部分功能可能無法正常使用', 'error');
    };
    document.head.appendChild(script);
}

// ApexCharts 圖表配置
function createNewsChart() {
    const options = {
        series: [{
            name: '新聞數量',
            data: monthlyCounts
        }],
        chart: {
            type: 'area',
            height: 280,
            toolbar: {
                show: false
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            },
            dropShadow: {
                enabled: true,
                color: '#000',
                top: 18,
                left: 7,
                blur: 10,
                opacity: 0.1
            }
        },
        stroke: {
            curve: 'smooth',
            width: 3,
            colors: ['#3B82F6']
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                type: 'vertical',
                opacityFrom: 0.8,
                opacityTo: 0.1,
                colorStops: [
                    {
                        offset: 0,
                        color: '#3B82F6',
                        opacity: 0.8
                    },
                    {
                        offset: 100,
                        color: '#06B6D4',
                        opacity: 0.1
                    }
                ]
            }
        },
        xaxis: {
            categories: monthlyLabels,
            labels: {
                style: {
                    colors: '#6B7280',
                    fontSize: '12px'
                }
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: '#6B7280',
                    fontSize: '12px'
                }
            }
        },
        grid: {
            borderColor: '#F3F4F6',
            strokeDashArray: 5
        },
        tooltip: {
            theme: 'light',
            x: {
                format: 'yyyy-MM-dd'
            }
        },
        colors: ['#3B82F6']
    };

    if (chartNews) {
        chartNews.destroy();
    }
    chartNews = new ApexCharts(document.querySelector("#chart-news-trend"), options);
    chartNews.render();
}

function createSourcesChart() {
    const colorPalette = [
        '#10B981', '#3B82F6', '#8B5CF6', '#EF4444', '#F59E0B', 
        '#06B6D4', '#EC4899', '#84CC16', '#F97316', '#6366F1'
    ];
    
    const options = {
        series: [{
            name: '文章數',
            data: topSourcesCounts
        }],
        chart: {
            type: 'bar',
            height: 280,
            toolbar: {
                show: false
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        plotOptions: {
            bar: {
                horizontal: true,
                borderRadius: 8,
                dataLabels: {
                    position: 'center'
                },
                distributed: true
            }
        },
        dataLabels: {
            enabled: true,
            style: {
                colors: ['#fff'],
                fontSize: '12px',
                fontWeight: 'bold'
            },
            formatter: function (val) {
                return val + ' 篇'
            }
        },
        xaxis: {
            categories: topSourcesLabels,
            labels: {
                style: {
                    colors: '#6B7280',
                    fontSize: '12px'
                }
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: '#6B7280',
                    fontSize: '12px'
                }
            }
        },
        grid: {
            borderColor: '#F3F4F6'
        },
        legend: {
            show: false
        },
        colors: colorPalette
    };

    if (chartSources) {
        chartSources.destroy();
    }
    chartSources = new ApexCharts(document.querySelector("#chart-top-sources"), options);
    chartSources.render();
}

function createCveChart() {
    const options = {
        series: cveCounts,
        chart: {
            type: 'donut',
            height: 280,
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        labels: cveLabels,
        colors: [
            '#8B5CF6', '#EC4899', '#EF4444', '#F59E0B', 
            '#10B981', '#06B6D4', '#3B82F6', '#6366F1'
        ],
        legend: {
            position: 'bottom',
            fontSize: '12px',
            labels: {
                colors: '#6B7280'
            },
            markers: {
                width: 8,
                height: 8
            }
        },
        plotOptions: {
            pie: {
                donut: {
                    size: '65%',
                    labels: {
                        show: true,
                        total: {
                            show: true,
                            showAlways: true,
                            label: 'Total CVE',
                            fontSize: '14px',
                            fontWeight: 600,
                            color: '#374151',
                            formatter: function (w) {
                                return w.globals.seriesTotals.reduce((a, b) => {
                                    return a + b
                                }, 0)
                            }
                        }
                    }
                }
            }
        },
        dataLabels: {
            enabled: true,
            style: {
                fontSize: '14px',
                fontWeight: 'bold',
                colors: ['#fff']
            },
            formatter: function (val, opts) {
                return Math.round(val) + '%'
            }
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function (val) {
                    return val + ' 個'
                }
            }
        }
    };

    if (chartCve) {
        chartCve.destroy();
    }
    chartCve = new ApexCharts(document.querySelector("#chart-cve-distribution"), options);
    chartCve.render();
}

// 建立圖表：若 ApexCharts 尚未載入則動態載入後再建立
function createCharts() {
    if (typeof ApexCharts === 'undefined') {
        console.warn('ApexCharts 尚未載入，嘗試動態載入');
        loadApexCharts(function() {
            try {
                createNewsChart();
                createSourcesChart();
                createCveChart();
                console.log('圖表建立成功 (動態載入後)');
            } catch (error) {
                console.error('圖表建立失敗:', error);
                showNotification('圖表載入失敗，請重新整理頁面', 'error');
            }
        });
        return;
    }

    try {
        createNewsChart();
        createSourcesChart();
        createCveChart();
        console.log('圖表建立成功');
    } catch (error) {
        console.error('圖表建立失敗:', error);
        showNotification('圖表載入失敗，請重新整理頁面', 'error');
    }
}

// 數字動畫函數
function animateNumber(elementId, targetValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const startValue = parseInt(element.textContent) || 0;
    const duration = 1000;
    const stepTime = 50;
    const steps = duration / stepTime;
    const increment = (targetValue - startValue) / steps;
    let currentValue = startValue;
    let step = 0;

    const timer = setInterval(() => {
        step++;
        currentValue += increment;
        
        if (step >= steps) {
            currentValue = targetValue;
            clearInterval(timer);
        }
        
        element.textContent = Math.round(currentValue).toLocaleString();
    }, stepTime);
}

// 進度條動畫
function animateProgressBar(elementId, targetPercent) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const currentPercent = parseFloat(element.style.width) || 0;
    const duration = 1500;
    const stepTime = 20;
    const steps = duration / stepTime;
    const increment = (targetPercent - currentPercent) / steps;
    let currentValue = currentPercent;
    let step = 0;

    const timer = setInterval(() => {
        step++;
        currentValue += increment;
        
        if (step >= steps) {
            currentValue = targetPercent;
            clearInterval(timer);
        }
        
        element.style.width = currentValue + '%';
        
        // 根據進度調整顏色
        if (currentValue < 30) {
            element.style.background = 'linear-gradient(to right, #EF4444, #F87171)';
        } else if (currentValue < 70) {
            element.style.background = 'linear-gradient(to right, #F59E0B, #FBBF24)';
        } else {
            element.style.background = 'linear-gradient(to right, #10B981, #34D399)';
        }
    }, stepTime);
}

// 刷新統計數據
function refreshStats() {
    const refreshBtn = document.getElementById('btn-refresh');
    if (!refreshBtn) return;
    
    const originalText = refreshBtn.innerHTML;
    
    // 顯示載入狀態
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>載入中...';
    refreshBtn.disabled = true;
    refreshBtn.classList.add('opacity-75', 'cursor-not-allowed');
    refreshBtn.classList.remove('hover:scale-105');
    
    showGlobalLoading();
    
    fetch('{{ url_for("admin.refresh_stats") }}', {
        credentials: 'same-origin'
    }).then(r => r.json()).then(data => {
        if (data && data.details) {
            // 數字動畫更新
            animateNumber('total-news', data.details.total_news || 0);
            animateNumber('total-sources', data.details.total_sources || 0);
            animateNumber('total-users', data.details.total_users || 0);
            animateNumber('total-cves', data.details.total_cves || 0);
            
            // 更新 POC 覆蓋率
            const pocElement = document.getElementById('poc-coverage');
            if (pocElement) {
                pocElement.textContent = data.details.poc_coverage || '0%';
            }
            animateProgressBar('poc-progress', data.details.poc_coverage_percent || 0);

            // 更新圖表資料
            monthlyLabels.length = 0; 
            monthlyLabels.push(...(data.details.monthly_labels || []));
            monthlyCounts.length = 0; 
            monthlyCounts.push(...(data.details.monthly_counts || []));
            topSourcesLabels.length = 0; 
            topSourcesLabels.push(...(data.details.top_sources_labels || []));
            topSourcesCounts.length = 0; 
            topSourcesCounts.push(...(data.details.top_sources_counts || []));
            cveLabels.length = 0; 
            cveLabels.push(...(data.details.cve_labels || []));
            cveCounts.length = 0; 
            cveCounts.push(...(data.details.cve_counts || []));

            // 重建圖表（確保 ApexCharts 已載入）
            loadApexCharts(function() {
                setTimeout(() => {
                    createCharts();
                }, 500);
            });
        }
        
        showNotification('數據已成功更新！', 'success');
        
    }).catch(err => {
        console.error('刷新統計資料失敗', err);
        showNotification('數據更新失敗，請稍後再試', 'error');
    }).finally(() => {
        // 恢復按鈕狀態
        setTimeout(() => {
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
            refreshBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            refreshBtn.classList.add('hover:scale-105');
            hideGlobalLoading();
        }, 1000);
    });
}

// 匯出統計數據
function exportStats() {
    showGlobalLoading();
    
    fetch('{{ url_for("admin.export_stats") }}', {
        credentials: 'same-origin'
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') {
            // 創建下載連結
            const blob = new Blob([JSON.stringify(data.data, null, 2)], 
                                 { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = data.filename || 'stats_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('統計數據已成功匯出！', 'success');
        } else {
            throw new Error(data.message || '匯出失敗');
        }
    }).catch(err => {
        console.error('匯出失敗:', err);
        showNotification('數據匯出失敗：' + err.message, 'error');
    }).finally(() => {
        hideGlobalLoading();
    });
}

// 全屏載入效果
function showGlobalLoading() {
    const loader = document.createElement('div');
    loader.id = 'global-loader';
    loader.className = 'fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center';
    loader.innerHTML = `
        <div class="bg-white rounded-2xl p-8 shadow-2xl flex items-center space-x-4">
            <div class="w-8 h-8 border-4 border-black border-t-transparent rounded-full animate-spin"></div>
            <span class="text-gray-700 font-medium">更新數據中...</span>
        </div>
    `;
    document.body.appendChild(loader);
}

function hideGlobalLoading() {
    const loader = document.getElementById('global-loader');
    if (loader) {
        loader.style.opacity = '0';
        setTimeout(() => loader.remove(), 300);
    }
}

// 通知系統
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-lg transform translate-x-full transition-all duration-300`;
    
    const colors = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        info: 'bg-blue-500 text-white'
    };
    
    const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle'
    };
    
    notification.className += ` ${colors[type]}`;
    notification.innerHTML = `
        <div class="flex items-center space-x-3">
            <i class="${icons[type]}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // 動畫進入
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // 自動移除
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// 自動刷新功能
function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        refreshStats();
    }, 30000); // 30秒自動刷新
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

// 響應式處理
function handleResize() {
    if (chartNews || chartSources || chartCve) {
        setTimeout(() => {
            createCharts();
        }, 300);
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    // 優先檢查是否已在 head 區載入，若尚未載入則動態載入
    loadApexCharts(function() {
        console.log('ApexCharts 已載入完成或已存在');
        createCharts();
        startAutoRefresh();
        
        // 響應式監聽
        window.addEventListener('resize', handleResize);
        
        // 頁面可見性變化時暫停/恢復自動刷新
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
        
        // 顯示歡迎通知
        setTimeout(() => {
            showNotification('統計儀表板已載入完成', 'success');
        }, 1500);
    });
});

// 頁面離開時清理
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
{% endblock %}
