<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown ç·¨è¼¯å™¨æ¸¬è©¦ - å³æ™‚é è¦½ç‰ˆ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Markdown ç›¸é—œåº« -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        .preview-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }
        
        .preview-content h1,
        .preview-content h2,
        .preview-content h3 {
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        
        .preview-content h1 { font-size: 2em; }
        .preview-content h2 { font-size: 1.5em; }
        .preview-content h3 { font-size: 1.25em; }
        
        .preview-content p {
            margin-bottom: 1em;
        }
        
        .preview-content code {
            background: #f6f8fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .preview-content pre {
            background: #f6f8fa;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }
        
        .preview-content pre code {
            background: none;
            padding: 0;
        }
        
        .preview-content a {
            color: #0969da;
            text-decoration: none;
        }
        
        .preview-content a:hover {
            text-decoration: underline;
        }
        
        .preview-content blockquote {
            border-left: 4px solid #d0d7de;
            padding-left: 1em;
            margin: 1em 0;
            color: #57606a;
        }
        
        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1rem 1.5rem;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .drag-over {
            background-color: #eff6ff !important;
            border: 2px dashed #3b82f6 !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Markdown ç·¨è¼¯å™¨æ¸¬è©¦</h1>
            <p class="text-gray-600 mt-2">å³æ™‚é è¦½ç‰ˆ - é è¦½å€åŸŸé è¨­é¡¯ç¤ºï¼Œä¸å¯é—œé–‰</p>
        </div>

        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- å·¥å…·åˆ— -->
            <div class="bg-gray-50 border-b border-gray-200 p-3 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <button type="button" onclick="insertMarkdown('**', '**', 'ç²—é«”æ–‡å­—')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm font-bold" 
                            title="ç²—é«” (Ctrl+B)">
                        B
                    </button>
                    <button type="button" onclick="insertMarkdown('*', '*', 'æ–œé«”æ–‡å­—')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm italic" 
                            title="æ–œé«” (Ctrl+I)">
                        I
                    </button>
                    <button type="button" onclick="insertMarkdown('`', '`', 'ç¨‹å¼ç¢¼')" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm font-mono" 
                            title="è¡Œå…§ç¨‹å¼ç¢¼">
                        &lt;/&gt;
                    </button>
                    <button type="button" onclick="insertLink()" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm" 
                            title="æ’å…¥é€£çµ (Ctrl+K)">
                        ğŸ”—
                    </button>
                    <button type="button" onclick="insertHeading()" 
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm font-bold" 
                            title="æ’å…¥æ¨™é¡Œ">
                        H
                    </button>
                </div>

                <div class="flex items-center space-x-3">
                    <div class="text-sm text-gray-500">
                        <span id="charCount">0</span> å­—
                    </div>
                </div>
            </div>

            <!-- ç·¨è¼¯å€åŸŸ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
                <!-- æ–‡å­—è¼¸å…¥å€ -->
                <div class="p-4 border-r border-gray-200" id="editorPane">
                    <textarea 
                        id="content" 
                        class="w-full h-[600px] p-4 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono"
                        placeholder="åœ¨æ­¤è¼¸å…¥ Markdown æ ¼å¼çš„æ–‡ç« å…§å®¹..."
                    ># æ­¡è¿ä½¿ç”¨ Markdown ç·¨è¼¯å™¨

é€™æ˜¯ä¸€å€‹æ¸¬è©¦æ–‡ä»¶ï¼Œç”¨ä¾†å±•ç¤º**å³æ™‚é è¦½**åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹è‰²

1. **å³æ™‚é è¦½** - é è¦½å€åŸŸé è¨­é¡¯ç¤º
2. **èªæ³•é«˜äº®** - æ”¯æ´ç¨‹å¼ç¢¼é«˜äº®
3. **è‡ªå‹•å„²å­˜** - æ¯ 3 ç§’è‡ªå‹•å„²å­˜è‰ç¨¿
4. **æ‹–æ‹½ä¸Šå‚³** - æ”¯æ´åœ–ç‰‡æ‹–æ‹½ä¸Šå‚³

## ç¨‹å¼ç¢¼ç¯„ä¾‹

```python
def hello_world():
    print("Hello, World!")
```

## å¼•ç”¨

> é€™æ˜¯ä¸€æ®µå¼•ç”¨æ–‡å­—

## é€£çµ

[GitHub](https://github.com)</textarea>
                </div>

                <!-- é è¦½å€ -->
                <div id="previewPane" class="p-4 bg-gray-50">
                    <div id="previewContent" class="preview-content h-[600px] overflow-y-auto p-4">
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="text-lg">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // å…¨åŸŸè®Šæ•¸
    let autoSaveTimer = null;
    let contentTextarea = null;
    let previewContent = null;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        contentTextarea = document.getElementById('content');
        previewContent = document.getElementById('previewContent');
        
        if (!contentTextarea) {
            console.error('æ‰¾ä¸åˆ°ç·¨è¼¯å™¨å…ƒç´ ');
            return;
        }

        // ç­‰å¾… CDN è¼‰å…¥
        waitForCDN().then(() => {
            console.log('CDN åº«å·²è¼‰å…¥');
            
            // ç¶å®šè¼¸å…¥äº‹ä»¶ - å³æ™‚æ›´æ–°é è¦½
            contentTextarea.addEventListener('input', function() {
                updateCharCount();
                updatePreview();
                scheduleAutoSave();
            });

            // ç¶å®šå¿«æ·éµ
            contentTextarea.addEventListener('keydown', handleKeyboardShortcuts);

            // æ‹–æ‹½ä¸Šå‚³
            initializeDragDrop();

            // åˆå§‹å­—æ•¸çµ±è¨ˆ
            updateCharCount();

            // åˆå§‹åŒ–é è¦½
            updatePreview();
            
            showToast('ç·¨è¼¯å™¨å·²å°±ç·’ [OK]', 'success');
        });
    });

    // ç­‰å¾… CDN åº«è¼‰å…¥
    function waitForCDN() {
        return new Promise((resolve) => {
            let attempts = 0;
            const maxAttempts = 10;
            
            const checkCDN = () => {
                if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                    // é…ç½® marked
                    if (marked.setOptions) {
                        marked.setOptions({
                            breaks: true,
                            gfm: true,
                            headerIds: true,
                            mangle: false,
                            sanitize: false,
                            smartLists: true,
                            smartypants: false
                        });
                    }
                    resolve(true);
                } else {
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(checkCDN, 200);
                    } else {
                        console.error('CDN è¼‰å…¥å¤±æ•—');
                        showToast('Markdown è§£æå™¨è¼‰å…¥å¤±æ•—', 'error');
                        resolve(false);
                    }
                }
            };
            
            checkCDN();
        });
    }

    // æ›´æ–°é è¦½
    function updatePreview() {
        if (!previewContent || typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
            return;
        }

        const content = contentTextarea.value.trim();

        if (!content) {
            previewContent.innerHTML = `
                <div class="text-center py-12 text-gray-400">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p class="text-lg">é–‹å§‹è¼¸å…¥ä»¥æŸ¥çœ‹é è¦½</p>
                </div>
            `;
            return;
        }

        try {
            // è§£æ Markdown
            const rawHtml = marked.parse(content);
            
            // æ¸…ç† HTML
            const cleanHtml = DOMPurify.sanitize(rawHtml, {
                ALLOWED_TAGS: [
                    'p', 'br', 'strong', 'em', 'u', 'del', 'mark',
                    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                    'ul', 'ol', 'li', 'dl', 'dt', 'dd',
                    'blockquote', 'pre', 'code',
                    'a', 'img',
                    'table', 'thead', 'tbody', 'tfoot', 'tr', 'th', 'td',
                    'div', 'span', 'hr'
                ],
                ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id'],
                KEEP_CONTENT: true
            });

            previewContent.innerHTML = cleanHtml;

            // é«˜äº®ç¨‹å¼ç¢¼
            if (typeof hljs !== 'undefined') {
                previewContent.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }

            // å¤–éƒ¨é€£çµè¨­å®š
            previewContent.querySelectorAll('a').forEach((link) => {
                if (link.hostname !== window.location.hostname) {
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                }
            });

        } catch (error) {
            console.error('é è¦½æ›´æ–°éŒ¯èª¤:', error);
            previewContent.innerHTML = `
                <div class="text-center py-12 text-red-500">
                    <p class="text-lg font-medium">é è¦½è§£æéŒ¯èª¤</p>
                    <p class="text-sm mt-2">${error.message}</p>
                </div>
            `;
        }
    }

    // æ›´æ–°å­—æ•¸çµ±è¨ˆ
    function updateCharCount() {
        const charCount = document.getElementById('charCount');
        if (charCount && contentTextarea) {
            const count = contentTextarea.value.length;
            charCount.textContent = count.toLocaleString();
        }
    }

    // æ’å…¥ Markdown æ¨™è¨˜
    function insertMarkdown(before, after, placeholder) {
        const start = contentTextarea.selectionStart;
        const end = contentTextarea.selectionEnd;
        const selectedText = contentTextarea.value.substring(start, end);
        const textToInsert = selectedText || placeholder;
        const newText = before + textToInsert + after;
        
        contentTextarea.setRangeText(newText, start, end, 'end');
        contentTextarea.focus();
        
        if (!selectedText) {
            contentTextarea.setSelectionRange(start + before.length, start + before.length + placeholder.length);
        }
        
        contentTextarea.dispatchEvent(new Event('input'));
    }

    // æ’å…¥é€£çµ
    function insertLink() {
        const url = prompt('è«‹è¼¸å…¥é€£çµç¶²å€ï¼š');
        if (url) {
            const text = prompt('è«‹è¼¸å…¥é€£çµæ–‡å­—ï¼š') || url;
            insertMarkdown('[', `](${url})`, text);
        }
    }

    // æ’å…¥æ¨™é¡Œ
    function insertHeading() {
        insertMarkdown('## ', '', 'æ¨™é¡Œæ–‡å­—');
    }

    // éµç›¤å¿«æ·éµ
    function handleKeyboardShortcuts(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
            e.preventDefault();
            insertMarkdown('**', '**', 'ç²—é«”æ–‡å­—');
        }
        
        if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
            e.preventDefault();
            insertMarkdown('*', '*', 'æ–œé«”æ–‡å­—');
        }
        
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            insertLink();
        }
    }

    // æ‹–æ‹½ä¸Šå‚³
    function initializeDragDrop() {
        const editorPane = document.getElementById('editorPane');
        
        editorPane.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            editorPane.classList.add('drag-over');
        });

        editorPane.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            editorPane.classList.remove('drag-over');
        });

        editorPane.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            editorPane.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    showToast('æ‹–æ‹½ä¸Šå‚³åŠŸèƒ½éœ€è¦å¾Œç«¯æ”¯æ´', 'info');
                }
            }
        });
    }

    // è‡ªå‹•å„²å­˜
    function scheduleAutoSave() {
        if (autoSaveTimer) {
            clearTimeout(autoSaveTimer);
        }
        
        autoSaveTimer = setTimeout(() => {
            const content = contentTextarea.value;
            localStorage.setItem('draft_content', content);
            localStorage.setItem('draft_time', Date.now());
            console.log('è‰ç¨¿å·²è‡ªå‹•å„²å­˜');
        }, 3000);
    }

    // Toast é€šçŸ¥
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = 'toast';
        
        const colors = {
            success: 'bg-green-50 text-green-800 border-green-200',
            error: 'bg-red-50 text-red-800 border-red-200',
            info: 'bg-blue-50 text-blue-800 border-blue-200'
        };
        
        toast.className += ' border ' + (colors[type] || colors.info);
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    </script>
</body>
</html>
